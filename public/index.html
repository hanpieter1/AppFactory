<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Factory</title>
    <style>
      :root {
        --bg-dark: #f5f6fb;
        --bg-card: #ffffff;
        --bg-sidebar: #1d2c57;
        --bg-hover: #eef1f8;
        --bg-input: #f5f6fb;
        --accent: #3b56a3;
        --accent-dim: #2d4480;
        --accent-red: #ea504e;
        --text: #090e1a;
        --text-muted: #555;
        --text-light: #7a8599;
        --border: #dce1ed;
        --success: #28a745;
        --danger: #ea504e;
        --info: #3b56a3;
        --radius: 8px;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-lg: 6px 6px 9px rgba(0, 0, 0, 0.12);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-dark);
        color: var(--text);
        min-height: 100vh;
      }
      button {
        cursor: pointer;
        font-family: inherit;
      }
      input,
      select {
        font-family: inherit;
      }

      /* ── Login View ── */
      #login-view {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #1d2c57 0%, #3b56a3 100%);
      }
      .login-card {
        background: var(--bg-card);
        border: none;
        border-radius: 12px;
        padding: 3rem;
        width: 100%;
        max-width: 400px;
        box-shadow: var(--shadow-lg);
      }
      .login-card h1 {
        color: var(--accent);
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      .login-card .subtitle {
        color: var(--text-muted);
        text-align: center;
        margin-bottom: 2rem;
        font-size: 0.9rem;
      }
      .form-group {
        margin-bottom: 1.25rem;
      }
      .form-group label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.4rem;
      }
      .form-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
      }
      .form-group input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 86, 163, 0.1);
      }
      .btn {
        padding: 0.7rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
      }
      .btn-primary {
        background: var(--accent);
        color: #ffffff;
        width: 100%;
        padding: 0.85rem;
        font-size: 1rem;
      }
      .btn-primary:hover {
        background: var(--accent-dim);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: #ffffff;
        color: var(--accent);
        border: 1px solid var(--border);
      }
      .btn-secondary:hover {
        background: var(--bg-hover);
        border-color: var(--accent);
      }
      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-success:hover {
        opacity: 0.85;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-danger:hover {
        opacity: 0.85;
      }
      .btn-info {
        background: var(--info);
        color: white;
      }
      .btn-info:hover {
        opacity: 0.85;
      }
      .error-msg {
        background: rgba(234, 80, 78, 0.08);
        border: 1px solid rgba(234, 80, 78, 0.25);
        color: var(--danger);
        padding: 0.75rem;
        border-radius: var(--radius);
        font-size: 0.85rem;
        margin-bottom: 1rem;
        display: none;
      }
      .error-msg.visible {
        display: block;
      }

      /* ── App Layout ── */
      #app-view {
        display: none;
        height: 100vh;
      }
      #app-view.active {
        display: flex;
      }
      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        border-right: none;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        transition: width 0.2s ease;
      }
      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .sidebar-header h2 {
        color: #ffffff;
        font-size: 1.3rem;
        font-weight: 700;
      }
      .sidebar-nav {
        flex: 1;
        padding: 1rem 0;
        overflow-y: auto;
      }
      .nav-item {
        display: flex;
        align-items: center;
        padding: 0.7rem 1.5rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s;
      }
      .nav-item:hover,
      .nav-item.active {
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
      }
      .nav-item.active {
        border-left: 3px solid var(--accent-red);
        color: #ffffff;
      }
      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
        padding: 0;
      }
      .sidebar.collapsed ~ .main {
        flex: 1;
      }
      .sidebar-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .sidebar-feedback-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius);
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .sidebar-feedback-btn:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--accent-red);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
      }
      .user-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #ffffff;
      }
      .user-role {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
      }
      .logout-btn {
        width: 100%;
        padding: 0.5rem;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius);
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        transition: all 0.2s;
      }
      .logout-btn:hover {
        color: var(--accent-red);
        border-color: var(--accent-red);
      }

      /* ── Top Bar (purple header) ── */
      .top-bar {
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        height: 48px;
        background: var(--bg-sidebar);
        position: relative;
        flex-shrink: 0;
      }
      .top-bar-brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .top-bar-hamburger {
        background: none;
        border: none;
        color: rgba(255,255,255,0.8);
        font-size: 1.3rem;
        cursor: pointer;
        padding: 0.25rem;
        line-height: 1;
      }
      .top-bar-hamburger:hover {
        color: #fff;
      }
      .top-bar-logo {
        width: 28px;
        height: 28px;
        background: #fff;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.7rem;
        color: var(--bg-sidebar);
      }
      .top-bar-title {
        color: #fff;
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      .top-bar-spacer {
        flex: 1;
      }
      .top-bar-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .top-bar-help {
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        font-size: 1.2rem;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .top-bar-help:hover {
        background: rgba(255,255,255,0.1);
        color: #fff;
      }
      .top-bar-user {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius);
        transition: background 0.2s;
      }
      .top-bar-user:hover {
        background: rgba(255,255,255,0.1);
      }
      .top-bar-user .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
      }
      .top-bar-user .user-name {
        color: #fff;
        font-size: 0.85rem;
      }
      .top-bar-user .user-role {
        color: rgba(255,255,255,0.6);
        font-size: 0.7rem;
      }
      .top-bar-arrow {
        color: rgba(255,255,255,0.6);
        font-size: 0.75rem;
        margin-left: 0.25rem;
      }
      .top-bar-dropdown {
        position: absolute;
        top: 100%;
        right: 1.5rem;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        z-index: 100;
      }
      .top-bar-dropdown.hidden {
        display: none;
      }
      .top-bar-dropdown a {
        display: block;
        padding: 0.6rem 1rem;
        color: var(--text);
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.15s;
      }
      .top-bar-dropdown a:hover {
        background: var(--bg-hover);
      }
      .top-bar-dropdown a:first-child {
        border-radius: var(--radius) var(--radius) 0 0;
      }
      .top-bar-dropdown a:last-child {
        border-radius: 0 0 var(--radius) var(--radius);
        color: var(--danger);
      }

      /* ── Main Content ── */
      .main {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .page-header h1 {
        font-size: 1.5rem;
        color: var(--bg-sidebar);
      }

      /* ── Toolbar ── */
      .toolbar {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 1.25rem;
        align-items: center;
      }
      .search-input {
        flex: 1;
        min-width: 200px;
        padding: 0.6rem 1rem;
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.9rem;
        outline: none;
      }
      .search-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 86, 163, 0.1);
      }
      .filter-select {
        padding: 0.6rem 0.75rem;
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.85rem;
        outline: none;
      }
      .filter-select:focus {
        border-color: var(--accent);
      }

      /* ── Table ── */
      .table-wrap {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead th {
        background: var(--bg-hover);
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        border-bottom: 2px solid var(--border);
      }
      thead th:hover {
        color: var(--accent);
      }
      thead th .sort-arrow {
        margin-left: 4px;
        font-size: 0.7rem;
      }
      tbody tr {
        border-top: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.1s;
      }
      tbody tr:hover {
        background: var(--bg-hover);
      }
      td {
        padding: 0.7rem 1rem;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      .badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .badge-active {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
      }
      .badge-inactive {
        background: rgba(234, 80, 78, 0.1);
        color: var(--danger);
      }
      .badge-blocked {
        background: rgba(255, 152, 0, 0.1);
        color: #e67e00;
      }
      .badge-role {
        background: rgba(59, 86, 163, 0.1);
        color: var(--accent);
        margin-right: 0.3rem;
      }
      .badge-ws {
        background: rgba(59, 86, 163, 0.1);
        color: var(--accent);
      }

      /* ── Pagination ── */
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border);
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .page-btn {
        padding: 0.35rem 0.75rem;
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--accent);
        font-size: 0.85rem;
        font-weight: 500;
      }
      .page-btn:hover:not(:disabled) {
        border-color: var(--accent);
      }
      .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      /* ── User Detail ── */
      #detail-view {
        display: none;
      }
      #detail-view.active {
        display: block;
      }
      #list-view {
        display: block;
      }
      #list-view.hidden {
        display: none;
      }
      .detail-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 700px;
        box-shadow: var(--shadow);
      }
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }
      .detail-header h2 {
        font-size: 1.3rem;
      }
      .detail-section {
        margin-bottom: 1.5rem;
      }
      .detail-section h3 {
        font-size: 0.85rem;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--bg-hover);
      }
      .detail-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.75rem;
        align-items: center;
      }
      .detail-row label {
        width: 120px;
        font-size: 0.85rem;
        color: var(--text-muted);
        flex-shrink: 0;
      }
      .detail-row input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.9rem;
        outline: none;
      }
      .detail-row input:focus {
        border-color: var(--accent);
      }
      .detail-row input[readonly] {
        opacity: 0.6;
        cursor: default;
        background: var(--bg-hover);
      }
      .detail-row span {
        font-size: 0.9rem;
      }
      .role-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .role-chip {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        background: rgba(59, 86, 163, 0.08);
        border: 1px solid rgba(59, 86, 163, 0.2);
        border-radius: 16px;
        font-size: 0.85rem;
        color: var(--accent);
      }
      .actions-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s;
      }
      .toast.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-success {
        background: var(--success);
        color: #ffffff;
      }
      .toast-error {
        background: var(--danger);
        color: #ffffff;
      }
      .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
      }
      .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
      }

      /* ── Create/Edit View ── */
      #create-view {
        display: none;
      }
      #create-view.active {
        display: block;
      }
      .form-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 600px;
        box-shadow: var(--shadow);
      }
      .form-card h2 {
        font-size: 1.3rem;
        margin-bottom: 0.25rem;
      }
      .form-card .form-subtitle {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 1.5rem;
      }
      .form-card .form-group {
        margin-bottom: 1rem;
      }
      .form-card .form-group label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.35rem;
      }
      .form-card .form-group input,
      .form-card .form-group select {
        width: 100%;
        padding: 0.6rem 0.75rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.9rem;
        outline: none;
      }
      .form-card .form-group input:focus,
      .form-card .form-group select:focus {
        border-color: var(--accent);
      }
      .form-row {
        display: flex;
        gap: 1rem;
      }
      .form-row .form-group {
        flex: 1;
      }
      .form-hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }
      .form-error {
        font-size: 0.8rem;
        color: var(--danger);
        margin-top: 0.25rem;
        display: none;
      }
      .form-error.visible {
        display: block;
      }
      .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
      }
      .form-actions .btn-primary {
        width: auto;
      }
      .checkbox-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .checkbox-chip {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 16px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.15s;
        user-select: none;
      }
      .checkbox-chip:hover {
        border-color: var(--accent);
      }
      .checkbox-chip.checked {
        background: rgba(59, 86, 163, 0.1);
        border-color: var(--accent);
        color: var(--accent);
      }
      .checkbox-chip input[type='checkbox'] {
        display: none;
      }
      .type-toggle {
        display: flex;
        gap: 0;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }
      .type-toggle label {
        flex: 1;
        padding: 0.6rem 1rem;
        text-align: center;
        font-size: 0.85rem;
        cursor: pointer;
        background: var(--bg-input);
        transition: all 0.15s;
      }
      .type-toggle label:hover {
        background: var(--bg-hover);
      }
      .type-toggle input[type='radio'] {
        display: none;
      }
      .type-toggle input[type='radio']:checked + label {
        background: rgba(59, 86, 163, 0.1);
        color: var(--accent);
        font-weight: 600;
      }

      /* ── Timesheet View (kept for future use) ── */
      #timesheet-view {
        display: none;
      }
      #timesheet-view.active {
        display: block;
      }
      .view-toggle {
        display: flex;
        gap: 0;
        margin-bottom: 1rem;
      }
      .view-toggle button {
        padding: 0.4rem 1.2rem;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .view-toggle button:first-child {
        border-radius: var(--radius) 0 0 var(--radius);
      }
      .view-toggle button:last-child {
        border-radius: 0 var(--radius) var(--radius) 0;
        border-left: none;
      }
      .view-toggle button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .week-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .week-nav h2 {
        font-size: 1.1rem;
        flex: 1;
        text-align: center;
      }
      .timesheet-grid {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      .timesheet-grid table {
        width: 100%;
        border-collapse: collapse;
      }
      .timesheet-grid thead th {
        background: var(--bg-hover);
        padding: 0.6rem 0.8rem;
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        border-bottom: 2px solid var(--border);
      }
      .timesheet-grid thead th:first-child {
        text-align: left;
      }
      .timesheet-grid tbody td {
        padding: 0.5rem 0.8rem;
        text-align: center;
        font-size: 0.9rem;
        border-top: 1px solid var(--border);
        cursor: pointer;
        min-width: 60px;
      }
      .timesheet-grid tbody td:first-child {
        text-align: left;
        font-weight: 600;
        cursor: default;
      }
      .timesheet-grid tbody td:last-child {
        font-weight: 700;
        cursor: default;
        background: var(--bg-hover);
      }
      .timesheet-grid
        tbody
        td:hover:not(:first-child):not(:last-child):not(.cell-approved):not(.cell-submitted) {
        background: rgba(59, 86, 163, 0.08);
      }
      .timesheet-grid tfoot td {
        padding: 0.6rem 0.8rem;
        text-align: center;
        font-weight: 700;
        font-size: 0.9rem;
        border-top: 2px solid var(--border);
        background: var(--bg-hover);
      }
      .timesheet-grid tfoot td:first-child {
        text-align: left;
      }
      .cell-approved {
        background: rgba(40, 167, 69, 0.06);
        color: var(--text-muted);
        cursor: not-allowed !important;
      }
      .cell-submitted {
        background: rgba(59, 86, 163, 0.06);
        color: var(--text-muted);
        cursor: not-allowed !important;
      }
      .cell-draft {
        cursor: pointer;
      }
      .cell-empty {
        cursor: pointer;
        color: var(--text-light);
      }
      .month-grid-wrapper {
        overflow-x: auto;
      }
      .month-grid-wrapper .timesheet-grid tbody td,
      .month-grid-wrapper .timesheet-grid thead th {
        min-width: 38px;
        padding: 0.4rem 0.3rem;
        font-size: 0.78rem;
      }
      .month-grid-wrapper .timesheet-grid tbody td:first-child,
      .month-grid-wrapper .timesheet-grid thead th:first-child {
        min-width: 140px;
        position: sticky;
        left: 0;
        z-index: 1;
        background: var(--bg-card);
      }
      .month-grid-wrapper .timesheet-grid thead th:first-child {
        background: var(--bg-hover);
      }
      .month-grid-wrapper .timesheet-grid tfoot td:first-child {
        position: sticky;
        left: 0;
        z-index: 1;
        background: var(--bg-hover);
      }
      .col-weekend {
        background: rgba(0, 0, 0, 0.04) !important;
      }
      .timesheet-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        align-items: center;
      }
      .week-total-label {
        flex: 1;
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .week-total-value {
        font-weight: 700;
        color: var(--text);
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 500;
      }
      .modal-backdrop.hidden {
        display: none;
      }
      .modal {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2rem;
        width: 100%;
        max-width: 420px;
        box-shadow: var(--shadow-lg);
      }
      .modal h3 {
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }
      .modal .form-group {
        margin-bottom: 1rem;
      }
      .modal .form-group label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.35rem;
      }
      .modal .form-group input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.9rem;
        outline: none;
      }
      .modal .form-group input:focus,
      .modal .form-group textarea:focus {
        border-color: var(--accent);
      }
      .modal .form-group textarea {
        width: 100%;
        padding: 0.6rem 0.75rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-size: 0.9rem;
        outline: none;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
      }
      .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1.25rem;
      }
      .modal-actions .btn-primary {
        width: auto;
      }
      /* KPI cards */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin: 1rem 0;
      }
      @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 500px) { .kpi-grid { grid-template-columns: 1fr; } }
      .kpi-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .kpi-card .kpi-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
      }
      .kpi-card .kpi-value {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--text);
      }
      .kpi-card .kpi-detail {
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Export dropdown */
      .export-dropdown { position: relative; display: inline-block; }
      .export-menu {
        position: absolute; bottom: 100%; left: 0; z-index: 100;
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: var(--radius); box-shadow: var(--shadow);
        min-width: 140px; margin-bottom: 4px;
      }
      .export-menu.hidden { display: none; }
      .export-menu button {
        display: block; width: 100%; text-align: left;
        padding: 0.5rem 0.75rem; border: none; background: none;
        font-size: 0.85rem; cursor: pointer;
      }
      .export-menu button:hover { background: var(--bg-hover); }

      /* ── Dashboard View ── */
      #dashboard-view {
        display: none;
      }
      #dashboard-view.active {
        display: block;
      }
      .homepage-header {
        margin-bottom: 2rem;
      }
      .homepage-header h1 {
        font-size: 1.6rem;
        color: var(--text);
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .homepage-header p {
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .module-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.25rem;
      }
      @media (max-width: 1100px) {
        .module-grid { grid-template-columns: repeat(2, 1fr); }
      }
      @media (max-width: 700px) {
        .module-grid { grid-template-columns: 1fr; }
      }
      .module-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.75rem;
        cursor: pointer;
        transition: box-shadow 0.2s, border-color 0.2s;
        display: flex;
        flex-direction: column;
        min-height: 200px;
      }
      .module-card:hover {
        box-shadow: var(--shadow-lg);
        border-color: var(--accent);
      }
      .module-card-icon {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .module-card-icon svg {
        width: 56px;
        height: 56px;
      }
      .module-card h3 {
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 0.5rem;
      }
      .module-card p {
        font-size: 0.85rem;
        color: var(--text-muted);
        line-height: 1.5;
        flex: 1;
      }
      .module-card-links {
        margin-top: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .module-card-links a {
        color: var(--accent);
        font-size: 0.85rem;
        text-decoration: none;
        cursor: pointer;
      }
      .module-card-links a:hover {
        text-decoration: underline;
      }

      /* ── Clients View ── */
      #clients-view {
        display: none;
      }
      #clients-view.active {
        display: block;
      }
      .filters {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
      }

      /* ── Portfolio View ── */
      #portfolio-view { display: none; }
      #portfolio-view.active { display: block; }
      .portfolio-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border);
        margin-bottom: 1.25rem;
      }
      .portfolio-tab {
        padding: 0.6rem 1.25rem;
        border: none;
        background: none;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: color 0.2s, border-color 0.2s;
      }
      .portfolio-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .portfolio-tab:disabled {
        color: #bbb;
        cursor: not-allowed;
      }
      .portfolio-toolbar {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      .portfolio-toolbar .search-input {
        flex: none;
        width: 280px;
      }
      .portfolio-toolbar .spacer { flex: 1; }
      .portfolio-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .portfolio-tab-panel { display: none; }
      .portfolio-tab-panel.active { display: block; }

      /* Open Tasks empty state */
      .empty-state-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
      }
      .empty-state-block svg {
        width: 80px;
        height: 80px;
        margin-bottom: 1rem;
        opacity: 0.4;
      }
      .empty-state-block h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 0.25rem;
      }
      .empty-state-block p {
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      /* Financial summary cards */
      .fin-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.25rem;
      }
      @media (max-width: 900px) {
        .fin-summary { grid-template-columns: repeat(2, 1fr); }
      }
      .fin-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.25rem;
      }
      .fin-card .fin-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
      }
      .fin-card .fin-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 0.15rem;
      }
      .fin-card .fin-sub {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.25rem;
      }
      .fin-card .fin-sub span {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .fin-card .fin-sub strong {
        font-size: 1.1rem;
        color: var(--text);
        margin-right: 0.25rem;
      }
      .fin-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
      @media (max-width: 1000px) {
        .fin-layout { grid-template-columns: 1fr; }
      }
      .fin-filter-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-bottom: 1rem;
      }
      .fin-filter-row label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text);
      }
      .fin-chart-placeholder {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        min-height: 300px;
        display: flex;
        flex-direction: column;
      }
      .fin-chart-bar-area {
        flex: 1;
        display: flex;
        align-items: flex-end;
        gap: 2rem;
        justify-content: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border);
        position: relative;
      }
      .fin-chart-bar-area::before {
        content: '';
        position: absolute;
        left: 0; right: 0;
        top: 0; bottom: 0;
        background: repeating-linear-gradient(to bottom, transparent, transparent calc(20% - 1px), var(--border) calc(20% - 1px), var(--border) 20%);
        pointer-events: none;
      }
      .fin-chart-bar {
        width: 40px;
        background: var(--accent);
        border-radius: 3px 3px 0 0;
        min-height: 2px;
        opacity: 0.3;
      }
      .fin-chart-labels {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding-top: 0.5rem;
      }
      .fin-chart-labels span {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-align: center;
        width: 40px;
        word-break: break-word;
      }
      .fin-y-labels {
        position: absolute;
        left: -2rem;
        top: 0; bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .fin-y-labels span {
        font-size: 0.7rem;
        color: var(--text-muted);
      }

      .proj-table th {
        position: relative;
        white-space: nowrap;
      }
      .proj-col-filter {
        display: block;
        width: 100%;
        margin-top: 4px;
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-input);
        color: var(--text);
      }
      .proj-col-filter:focus {
        outline: none;
        border-color: var(--accent);
      }
      .proj-table td { vertical-align: middle; }
      .proj-status-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
      }
      .proj-status-badge.intake { background: #e8f0fe; color: #1a56db; }
      .proj-status-badge.discovery { background: #fef3c7; color: #92400e; }
      .proj-status-badge.development { background: #dbeafe; color: #1e40af; }
      .proj-status-badge.testing { background: #ede9fe; color: #5b21b6; }
      .proj-status-badge.live { background: #d1fae5; color: #065f46; }
      .proj-status-badge.decommissioned { background: #fce7e7; color: #991b1b; }
      .proj-status-badge.on-hold { background: #f3f4f6; color: #6b7280; }
      .proj-alert-dot {
        display: inline-block;
        width: 10px; height: 10px;
        border-radius: 50%;
        margin-right: 4px;
        vertical-align: middle;
      }
      .proj-alert-dot.green { background: #28a745; }
      .proj-alert-dot.orange { background: #f59e0b; }
      .proj-alert-dot.red { background: #ea504e; }

      /* ── New Project Form ── */
      #project-form-view { display: none; }
      #project-form-view.active { display: block; }
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
      }
      .breadcrumb a {
        color: var(--accent);
        text-decoration: none;
        cursor: pointer;
      }
      .breadcrumb a:hover { text-decoration: underline; }
      .breadcrumb .sep { color: var(--text-light); }
      .project-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem 2rem;
      }
      @media (max-width: 800px) {
        .project-form-grid { grid-template-columns: 1fr; }
      }
      .project-form-grid .form-group {
        margin-bottom: 0.5rem;
      }
      .project-form-grid .form-group.full-width {
        grid-column: 1 / -1;
      }
      .project-form-grid label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.3rem;
      }
      .project-form-grid input,
      .project-form-grid select,
      .project-form-grid textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 0.9rem;
        background: var(--bg-input);
      }
      .project-form-grid textarea {
        min-height: 80px;
        resize: vertical;
      }
      .project-form-grid input:focus,
      .project-form-grid select:focus,
      .project-form-grid textarea:focus {
        outline: none;
        border-color: var(--accent);
      }
    </style>
  </head>
  <body>
    <!-- ── Login View ── -->
    <div id="login-view">
      <div class="login-card">
        <h1>App Factory</h1>
        <p class="subtitle">Sign in to your account</p>
        <div id="login-error" class="error-msg"></div>
        <form id="login-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" autocomplete="username" autofocus />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" autocomplete="current-password" />
          </div>
          <button type="submit" class="btn btn-primary" id="login-btn">Sign In</button>
        </form>
      </div>
    </div>

    <!-- ── App View ── -->
    <div id="app-view">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h2>App Factory</h2>
        </div>
        <nav class="sidebar-nav" id="sidebar-nav"></nav>
        <div class="sidebar-footer">
          <button class="sidebar-feedback-btn" id="open-feedback-btn" title="Send Feedback">
            &#9993; Feedback
          </button>
          <div class="user-info">
            <div class="user-avatar" id="user-avatar"></div>
            <div>
              <div class="user-name" id="user-display-name"></div>
              <div class="user-role" id="user-display-role"></div>
            </div>
          </div>
          <button class="logout-btn" id="logout-btn">Sign Out</button>
        </div>
      </aside>

      <main class="main">
        <div class="top-bar">
          <div class="top-bar-brand">
            <button class="top-bar-hamburger" id="sidebar-toggle" title="Toggle menu">&#9776;</button>
            <div class="top-bar-logo">AF</div>
            <span class="top-bar-title">AppFactory Suite</span>
          </div>
          <div class="top-bar-spacer"></div>
          <div class="top-bar-actions">
            <button class="top-bar-help" title="Help">?</button>
          </div>
          <div class="top-bar-dropdown hidden" id="top-bar-dropdown">
            <a id="top-bar-security">Beveiliging</a>
            <a id="top-bar-logout">Uitloggen</a>
          </div>
        </div>
        <div class="main-content">

        <!-- Dashboard / Homepage View -->
        <div id="dashboard-view">
          <div class="homepage-header">
            <h1>Homepage</h1>
            <p>Below you see the available modules of the Low-code portaal.</p>
          </div>
          <div class="module-grid">

            <!-- Portfolio -->
            <div class="module-card" data-module="portfolio">
              <div class="module-card-icon">
                <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="8" y="20" width="50" height="40" rx="4" fill="#FFF3CD" stroke="#F0C040" stroke-width="2"/>
                  <rect x="18" y="14" width="50" height="40" rx="4" fill="#FFF8E1" stroke="#F0C040" stroke-width="2"/>
                  <circle cx="43" cy="34" r="8" fill="#F0C040" opacity="0.4"/>
                  <path d="M35 42 L43 34 L48 38 L58 28" stroke="#D4A020" stroke-width="2" fill="none" stroke-linecap="round"/>
                  <rect x="22" y="46" width="20" height="3" rx="1.5" fill="#E0B030" opacity="0.5"/>
                </svg>
              </div>
              <h3>Portfolio</h3>
              <p>Use the portfolio module to manage your portfolio of Mendix apps from ideation to development - intakes, estimates, and finances.</p>
            </div>

            <!-- Activities -->
            <div class="module-card" data-module="activities">
              <div class="module-card-icon">
                <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="12" y="16" width="56" height="48" rx="4" fill="#E8F5E9" stroke="#66BB6A" stroke-width="2"/>
                  <circle cx="40" cy="32" r="4" fill="#EF5350"/>
                  <path d="M40 32 L40 20" stroke="#EF5350" stroke-width="2" stroke-linecap="round"/>
                  <path d="M20 44 L32 36 L44 42 L56 30 L64 34" stroke="#66BB6A" stroke-width="2" fill="none" stroke-linecap="round"/>
                  <rect x="18" y="52" width="44" height="3" rx="1.5" fill="#A5D6A7" opacity="0.6"/>
                </svg>
              </div>
              <h3>Activities</h3>
              <p>Use the activities module to track and manage recurring activities in your App Factory.</p>
            </div>

            <!-- Playbooks -->
            <div class="module-card" data-module="playbooks">
              <div class="module-card-icon">
                <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="10" y="12" width="40" height="56" rx="3" fill="#E3F2FD" stroke="#42A5F5" stroke-width="2"/>
                  <rect x="30" y="12" width="40" height="56" rx="3" fill="#BBDEFB" stroke="#42A5F5" stroke-width="2"/>
                  <path d="M38 28 L58 28" stroke="#42A5F5" stroke-width="2" stroke-linecap="round"/>
                  <path d="M38 38 L54 38" stroke="#42A5F5" stroke-width="2" stroke-linecap="round"/>
                  <path d="M38 48 L50 48" stroke="#42A5F5" stroke-width="2" stroke-linecap="round"/>
                  <circle cx="42" cy="22" r="3" fill="#1E88E5" opacity="0.4"/>
                </svg>
              </div>
              <h3>Playbooks</h3>
              <p>Use the playbook module as guidance to set up the COE using the Mendix App Factory Framework.</p>
            </div>

            <!-- Assessment -->
            <div class="module-card" data-module="assessment">
              <div class="module-card-icon">
                <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="14" y="18" width="52" height="44" rx="4" fill="#FFF3CD" stroke="#F0C040" stroke-width="2"/>
                  <path d="M26 38 L34 46 L54 26" stroke="#F0C040" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="20" y="52" width="40" height="3" rx="1.5" fill="#E0B030" opacity="0.4"/>
                  <circle cx="56" cy="22" r="6" fill="#FFF8E1" stroke="#F0C040" stroke-width="1.5"/>
                  <path d="M54 22 L56 24 L59 20" stroke="#E0B030" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                </svg>
              </div>
              <h3>Assessment</h3>
              <p>Use the assessment module to score and assess the maturity of the current application landscape according to the Mendix App Factory Framework.</p>
            </div>

            <!-- Guidelines & Documentation -->
            <div class="module-card" data-module="guidelines">
              <div class="module-card-icon">
                <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="10" y="16" width="36" height="48" rx="3" fill="#E3F2FD" stroke="#42A5F5" stroke-width="2"/>
                  <rect x="34" y="16" width="36" height="48" rx="3" fill="#BBDEFB" stroke="#42A5F5" stroke-width="2"/>
                  <path d="M18 30 L38 30" stroke="#90CAF9" stroke-width="2" stroke-linecap="round"/>
                  <path d="M18 38 L34 38" stroke="#90CAF9" stroke-width="2" stroke-linecap="round"/>
                  <path d="M42 30 L62 30" stroke="#42A5F5" stroke-width="2" stroke-linecap="round"/>
                  <path d="M42 38 L58 38" stroke="#42A5F5" stroke-width="2" stroke-linecap="round"/>
                  <path d="M42 46 L54 46" stroke="#42A5F5" stroke-width="2" stroke-linecap="round"/>
                  <circle cx="58" cy="22" r="7" fill="#E3F2FD" stroke="#42A5F5" stroke-width="1.5"/>
                  <path d="M58 19 L58 23 L61 23" stroke="#42A5F5" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                </svg>
              </div>
              <h3>Guidelines &amp; documentation</h3>
              <p>Use the documentation module to manage your Mendix development guidelines and app documentation.</p>
              <div class="module-card-links">
                <a onclick="showToast('Company guidelines coming soon')">&#8226; Company guidelines</a>
                <a onclick="showToast('Project documentation coming soon')">&#8226; Project documentation</a>
                <a onclick="showToast('Development library coming soon')">&#8226; Development library</a>
              </div>
            </div>

          </div>
        </div>

        <!-- Users View -->
        <div id="users-view">

        <!-- User List -->
        <div id="list-view">
          <div class="page-header">
            <h1>User Management</h1>
            <button class="btn btn-primary btn-sm" id="new-user-btn" style="width: auto">
              + New User
            </button>
          </div>

          <div class="toolbar">
            <input
              type="text"
              class="search-input"
              id="search-input"
              placeholder="Search users..."
            />
            <select class="filter-select" id="filter-active">
              <option value="">All Status</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
            <select class="filter-select" id="filter-type">
              <option value="">All Types</option>
              <option value="local">Local Users</option>
              <option value="webservice">Web Service</option>
            </select>
            <select class="filter-select" id="filter-role">
              <option value="">All Roles</option>
            </select>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th data-sort="name">Name <span class="sort-arrow"></span></th>
                  <th data-sort="fullName">Full Name <span class="sort-arrow"></span></th>
                  <th>Email</th>
                  <th data-sort="active">Status <span class="sort-arrow"></span></th>
                  <th>Type</th>
                  <th data-sort="lastLogin">Last Login <span class="sort-arrow"></span></th>
                </tr>
              </thead>
              <tbody id="user-table-body">
                <tr>
                  <td colspan="6" class="loading">Loading...</td>
                </tr>
              </tbody>
            </table>
            <div class="pagination">
              <span id="pagination-info"></span>
              <div class="pagination-controls">
                <select class="filter-select" id="page-size" style="width: auto">
                  <option value="10">10</option>
                  <option value="20" selected>20</option>
                  <option value="50">50</option>
                </select>
                <button class="page-btn" id="prev-page">&laquo; Prev</button>
                <span id="page-indicator"></span>
                <button class="page-btn" id="next-page">Next &raquo;</button>
              </div>
            </div>
          </div>
        </div>

        <!-- User Detail -->
        <div id="detail-view">
          <div class="detail-card">
            <div class="detail-header">
              <h2 id="detail-title">User Detail</h2>
              <button class="btn btn-secondary btn-sm" id="back-btn">&larr; Back</button>
            </div>

            <div class="detail-section">
              <h3>Profile</h3>
              <div class="detail-row">
                <label>Username</label>
                <input type="text" id="detail-name" readonly />
              </div>
              <div class="detail-row">
                <label>Full Name</label>
                <input type="text" id="detail-fullname" />
              </div>
              <div class="detail-row">
                <label>Email</label>
                <input type="text" id="detail-email" />
              </div>
              <div class="actions-row">
                <button class="btn btn-primary btn-sm" id="save-profile-btn">Save Profile</button>
              </div>
            </div>

            <div class="detail-section">
              <h3>Status</h3>
              <div class="detail-row">
                <label>Active</label>
                <span id="detail-active"></span>
              </div>
              <div class="detail-row">
                <label>Blocked</label>
                <span id="detail-blocked"></span>
              </div>
              <div class="detail-row">
                <label>Failed Logins</label>
                <span id="detail-failed-logins"></span>
              </div>
              <div class="detail-row">
                <label>Last Login</label>
                <span id="detail-last-login"></span>
              </div>
              <div class="actions-row">
                <button class="btn btn-success btn-sm" id="activate-btn">Activate</button>
                <button class="btn btn-danger btn-sm" id="deactivate-btn">Deactivate</button>
                <button class="btn btn-info btn-sm" id="unblock-btn" style="display: none">
                  Unblock
                </button>
              </div>
            </div>

            <div class="detail-section">
              <h3>Roles</h3>
              <div class="role-list" id="detail-roles"></div>
              <div class="actions-row">
                <button class="btn btn-secondary btn-sm" id="edit-roles-btn">Edit Roles</button>
              </div>
            </div>

            <div class="detail-section">
              <h3>Password</h3>
              <div class="actions-row">
                <button class="btn btn-secondary btn-sm" id="change-pw-btn">Change Password</button>
                <button class="btn btn-secondary btn-sm" id="reset-pw-btn">
                  Reset to Temporary
                </button>
                <span
                  id="temp-password"
                  style="font-family: monospace; color: var(--accent); font-size: 0.9rem"
                ></span>
              </div>
            </div>

            <div class="detail-section">
              <h3>Info</h3>
              <div class="detail-row">
                <label>ID</label>
                <span id="detail-id" style="font-family: monospace; font-size: 0.8rem"></span>
              </div>
              <div class="detail-row">
                <label>User Type</label>
                <span id="detail-user-type"></span>
              </div>
              <div class="detail-row">
                <label>Created</label>
                <span id="detail-created"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Create User -->
        <div id="create-view">
          <div class="form-card">
            <div class="detail-header">
              <div>
                <h2 id="create-title">New User</h2>
                <p class="form-subtitle" id="create-subtitle">Create a new local user account</p>
              </div>
              <button class="btn btn-secondary btn-sm" id="create-back-btn">&larr; Back</button>
            </div>

            <div id="create-error" class="error-msg"></div>

            <div class="form-group">
              <label>Account Type</label>
              <div class="type-toggle">
                <input type="radio" name="user-type" id="type-local" value="local" checked />
                <label for="type-local">Local User</label>
                <input type="radio" name="user-type" id="type-webservice" value="webservice" />
                <label for="type-webservice">Web Service</label>
              </div>
            </div>

            <div class="form-group">
              <label for="create-name">Username *</label>
              <input type="text" id="create-name" placeholder="e.g. john.doe" autocomplete="off" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="create-password">Password *</label>
                <input type="password" id="create-password" autocomplete="new-password" />
                <div class="form-hint">Min 8 chars, 1 uppercase, 1 digit</div>
              </div>
              <div class="form-group">
                <label for="create-confirm">Confirm Password *</label>
                <input type="password" id="create-confirm" autocomplete="new-password" />
              </div>
            </div>

            <div class="form-group">
              <label for="create-fullname">Full Name</label>
              <input type="text" id="create-fullname" placeholder="e.g. John Doe" />
            </div>

            <div class="form-group" id="create-email-group">
              <label for="create-email">Email</label>
              <input type="email" id="create-email" placeholder="e.g. john@example.com" />
            </div>

            <div class="form-group">
              <label>Roles</label>
              <div class="checkbox-grid" id="create-roles"></div>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary btn-sm" id="create-submit-btn">Create User</button>
              <button class="btn btn-secondary btn-sm" id="create-cancel-btn">Cancel</button>
            </div>
          </div>
        </div>

        </div><!-- /users-view -->

        <!-- Clients View -->
        <div id="clients-view">
          <div class="page-header">
            <h1>Klanten</h1>
            <button class="btn btn-primary btn-sm" id="create-client-btn" style="width: auto">
              Nieuwe klant
            </button>
          </div>
          <div class="filters">
            <input
              type="text"
              id="clients-search"
              placeholder="Zoek op naam of code..."
              class="search-input"
              style="flex: none; width: 300px"
            />
            <label style="font-size: 0.9rem; color: var(--text-muted)">
              <input type="checkbox" id="clients-show-inactive" style="margin-right: 0.5rem" />
              Toon inactieve klanten
            </label>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="cursor: pointer" data-sort="code">
                    Code <span class="sort-arrow" id="sort-code-indicator"></span>
                  </th>
                  <th style="cursor: pointer" data-sort="name">
                    Naam <span class="sort-arrow" id="sort-name-indicator"></span>
                  </th>
                  <th>Aantal projecten</th>
                  <th>Status</th>
                  <th>Acties</th>
                </tr>
              </thead>
              <tbody id="clients-table-body">
                <tr>
                  <td colspan="5" class="loading">Laden...</td>
                </tr>
              </tbody>
            </table>
            <div class="pagination" id="clients-pagination" style="display: none">
              <span id="clients-page-info">Pagina 1 van 1</span>
              <div class="pagination-controls">
                <button class="page-btn" id="clients-prev-page" disabled>Vorige</button>
                <button class="page-btn" id="clients-next-page" disabled>Volgende</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Portfolio View -->
        <div id="portfolio-view">
          <div class="page-header">
            <h1>Portfolio</h1>
          </div>
          <div class="portfolio-tabs">
            <button class="portfolio-tab active" data-tab="projects">Projects</button>
            <button class="portfolio-tab" data-tab="open-tasks">Open Tasks</button>
            <button class="portfolio-tab" data-tab="estimates" disabled>Estimates</button>
            <button class="portfolio-tab" data-tab="financial">Financial data</button>
          </div>

          <!-- Projects Tab -->
          <div class="portfolio-tab-panel active" data-panel="projects">
            <div class="portfolio-toolbar">
              <input type="text" id="proj-search" class="search-input" placeholder="Search..." />
              <div class="spacer"></div>
              <div class="portfolio-actions">
                <div class="export-dropdown">
                  <button class="btn btn-secondary btn-sm" id="proj-export-btn" style="width:auto">Export list &#9660;</button>
                  <div class="export-menu hidden" id="proj-export-menu">
                    <button data-format="csv">Export as CSV</button>
                    <button data-format="xlsx">Export as Excel</button>
                  </div>
                </div>
                <button class="btn btn-primary btn-sm" id="new-project-btn" style="width:auto">+ New Project</button>
              </div>
            </div>
            <div class="table-wrap">
              <table class="proj-table">
                <thead>
                  <tr>
                    <th>
                      Name
                      <input type="text" class="proj-col-filter" id="proj-filter-name" placeholder="Filter..." />
                    </th>
                    <th>
                      Status
                      <select class="proj-col-filter" id="proj-filter-status">
                        <option value="">All</option>
                      </select>
                    </th>
                    <th>
                      Department
                      <input type="text" class="proj-col-filter" id="proj-filter-dept" placeholder="Filter..." />
                    </th>
                    <th>
                      Team
                      <input type="text" class="proj-col-filter" id="proj-filter-team" placeholder="Filter..." />
                    </th>
                    <th>
                      Domain
                      <select class="proj-col-filter" id="proj-filter-domain">
                        <option value="">All</option>
                      </select>
                    </th>
                    <th>
                      Alert
                      <select class="proj-col-filter" id="proj-filter-alert">
                        <option value="">All</option>
                      </select>
                    </th>
                    <th>
                      Governance
                      <select class="proj-col-filter" id="proj-filter-governance">
                        <option value="">All</option>
                      </select>
                    </th>
                  </tr>
                </thead>
                <tbody id="proj-table-body">
                  <tr><td colspan="7" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Open Tasks Tab -->
          <div class="portfolio-tab-panel" data-panel="open-tasks">
            <div class="portfolio-toolbar">
              <input type="text" id="tasks-search" class="search-input" placeholder="Search on Project, Title, or Phase..." style="width:360px" />
            </div>
            <div class="table-wrap">
              <table class="proj-table">
                <thead>
                  <tr>
                    <th style="min-width:200px">Project</th>
                    <th>To Do</th>
                    <th>Phase</th>
                    <th>
                      Alert level
                      <select class="proj-col-filter" id="tasks-filter-alert">
                        <option value="">All</option>
                      </select>
                    </th>
                  </tr>
                </thead>
                <tbody id="tasks-table-body">
                </tbody>
              </table>
            </div>
            <div class="empty-state-block" id="tasks-empty-state">
              <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="10" width="60" height="80" rx="6" stroke="#999" stroke-width="2.5" fill="#f5f5f5"/>
                <rect x="20" y="10" width="60" height="16" rx="6" fill="#ddd"/>
                <line x1="32" y1="42" x2="68" y2="42" stroke="#bbb" stroke-width="2" stroke-linecap="round"/>
                <line x1="32" y1="54" x2="68" y2="54" stroke="#bbb" stroke-width="2" stroke-linecap="round"/>
                <line x1="32" y1="66" x2="56" y2="66" stroke="#bbb" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <h3>No open tasks found</h3>
              <p>It seems like you are all on track!</p>
            </div>
          </div>

          <!-- Financial Data Tab -->
          <div class="portfolio-tab-panel" data-panel="financial">
            <div class="fin-summary">
              <div class="fin-card">
                <div class="fin-value" id="fin-capex">0</div>
                <div class="fin-label">CAPEX</div>
              </div>
              <div class="fin-card">
                <div class="fin-value" id="fin-opex">0</div>
                <div class="fin-label">OPEX</div>
              </div>
              <div class="fin-card">
                <div class="fin-value" id="fin-investment">0</div>
                <div class="fin-label">Initial Investment</div>
              </div>
              <div class="fin-card">
                <div class="fin-sub">
                  <span><strong id="fin-ben-onetime">0</strong> (One Time)</span>
                  <span><strong id="fin-ben-recurring">0</strong> (Recurring)</span>
                </div>
                <div class="fin-label">Financial Benefits</div>
              </div>
            </div>
            <div class="fin-filter-row">
              <label>Department filter</label>
              <select class="filter-select" id="fin-dept-filter" style="width:200px">
                <option value="">All</option>
              </select>
            </div>
            <div class="fin-layout">
              <div>
                <div class="portfolio-toolbar" style="margin-bottom:0.75rem">
                  <input type="text" id="fin-search" class="search-input" placeholder="Search financial data.." style="width:280px" />
                </div>
                <div class="table-wrap">
                  <table class="proj-table">
                    <thead>
                      <tr>
                        <th>Project</th>
                        <th>CAPEX</th>
                        <th>OPEX</th>
                        <th>Ben. One Time</th>
                        <th>Ben. Rec.</th>
                        <th>Ben. Realized</th>
                        <th>Costs</th>
                      </tr>
                    </thead>
                    <tbody id="fin-table-body">
                      <tr><td colspan="7" class="empty-state">No financial data available</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="fin-chart-placeholder">
                <div class="fin-chart-bar-area" style="position:relative; padding-left: 2rem;">
                  <div class="fin-y-labels">
                    <span>1</span>
                    <span>0.8</span>
                    <span>0.6</span>
                    <span>0.4</span>
                    <span>0.2</span>
                    <span>0</span>
                  </div>
                  <div class="fin-chart-bar" style="height: 2px;"></div>
                  <div class="fin-chart-bar" style="height: 2px;"></div>
                  <div class="fin-chart-bar" style="height: 2px;"></div>
                  <div class="fin-chart-bar" style="height: 2px;"></div>
                  <div class="fin-chart-bar" style="height: 2px;"></div>
                </div>
                <div class="fin-chart-labels">
                  <span>CAPEX</span>
                  <span>OPEX</span>
                  <span>Initial Investment</span>
                  <span>Financial Benefits</span>
                  <span>Realized Benefits</span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- New / Edit Project Form -->
        <div id="project-form-view">
          <div class="breadcrumb">
            <a id="proj-breadcrumb-home">Homepage</a>
            <span class="sep">&gt;</span>
            <a id="proj-breadcrumb-portfolio">Portfolio</a>
            <span class="sep">&gt;</span>
            <span id="proj-breadcrumb-current">New project</span>
          </div>
          <div class="form-card" style="max-width: 900px">
            <div class="detail-header">
              <h2 id="project-form-title">New project</h2>
            </div>
            <div id="project-form-error" class="error-msg"></div>
            <div class="project-form-grid">
              <div class="form-group">
                <label for="pf-name">Name *</label>
                <input type="text" id="pf-name" placeholder="Project name" />
              </div>
              <div class="form-group">
                <label for="pf-reference">Reference number</label>
                <input type="text" id="pf-reference" placeholder="e.g. PRJ-001" />
              </div>
              <div class="form-group">
                <label for="pf-department">Department</label>
                <select id="pf-department">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-team">Team</label>
                <select id="pf-team">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-master-project">Master project</label>
                <select id="pf-master-project">
                  <option value="">-- None --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-status">Status</label>
                <select id="pf-status"></select>
              </div>
              <div class="form-group">
                <label for="pf-domain">Domain</label>
                <select id="pf-domain">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-process">Process</label>
                <select id="pf-process">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-app-size">App size</label>
                <select id="pf-app-size">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-complexity">Complexity</label>
                <select id="pf-complexity">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-alert-level">Alert level</label>
                <select id="pf-alert-level">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-governance-status">Governance status</label>
                <select id="pf-governance-status">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="pf-governance-template">Governance template</label>
                <input type="text" id="pf-governance-template" />
              </div>
              <div class="form-group">
                <label for="pf-infra-template">Infrastructure template</label>
                <input type="text" id="pf-infra-template" />
              </div>
              <div class="form-group">
                <label for="pf-ops-template">Operations template</label>
                <input type="text" id="pf-ops-template" />
              </div>
              <div class="form-group">
                <label for="pf-start-date">Start date</label>
                <input type="date" id="pf-start-date" />
              </div>
              <div class="form-group">
                <label for="pf-go-live-date">Go-live date</label>
                <input type="date" id="pf-go-live-date" />
              </div>
              <div class="form-group full-width">
                <label for="pf-description">Description</label>
                <textarea id="pf-description" placeholder="Project description..."></textarea>
              </div>
            </div>
            <div class="form-actions" style="margin-top: 1.25rem">
              <button class="btn btn-primary btn-sm" id="project-save-btn" style="width:auto">Save</button>
              <button class="btn btn-secondary btn-sm" id="project-cancel-btn" style="width:auto">Cancel</button>
              <span style="flex: 1"></span>
              <button class="btn btn-danger btn-sm" id="project-delete-btn" style="width:auto; display:none">Delete</button>
            </div>
          </div>
        </div>

        </div><!-- /main-content -->
      </main>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-backdrop hidden" id="password-modal">
      <div class="modal">
        <h3>Change Password</h3>
        <div id="pw-modal-error" class="error-msg"></div>
        <div class="form-group">
          <label for="pw-new">New Password</label>
          <input type="password" id="pw-new" autocomplete="new-password" />
          <div class="form-hint">Min 8 chars, 1 uppercase, 1 digit</div>
        </div>
        <div class="form-group">
          <label for="pw-confirm">Confirm Password</label>
          <input type="password" id="pw-confirm" autocomplete="new-password" />
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary btn-sm" id="pw-modal-cancel">Cancel</button>
          <button class="btn btn-primary btn-sm" id="pw-modal-save" style="width: auto">
            Change Password
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Roles Modal -->
    <div class="modal-backdrop hidden" id="roles-modal">
      <div class="modal">
        <h3>Edit Roles</h3>
        <div class="checkbox-grid" id="roles-modal-list"></div>
        <div class="modal-actions">
          <button class="btn btn-secondary btn-sm" id="roles-modal-cancel">Cancel</button>
          <button class="btn btn-primary btn-sm" id="roles-modal-save" style="width: auto">
            Save Roles
          </button>
        </div>
      </div>
    </div>

    <!-- Client Modal -->
    <div class="modal-backdrop hidden" id="client-modal">
      <div class="modal">
        <h3 id="client-modal-title">Nieuwe klant</h3>
        <div id="client-modal-error" class="error-msg"></div>
        <div class="form-group">
          <label for="client-code">Code *</label>
          <input
            type="text"
            id="client-code"
            maxlength="20"
            placeholder="Bijv. ACME"
          />
          <div class="form-hint">Unieke code, max 20 karakters</div>
        </div>
        <div class="form-group">
          <label for="client-name">Naam *</label>
          <input
            type="text"
            id="client-name"
            maxlength="100"
            placeholder="Bijv. ACME Corporation"
          />
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer">
            <input type="checkbox" id="client-active" checked />
            Actief
          </label>
        </div>
        <div class="modal-actions" style="justify-content: space-between">
          <button
            class="btn btn-danger btn-sm"
            id="client-delete-btn"
            style="display: none; width: auto"
          >
            Verwijderen
          </button>
          <span style="flex: 1"></span>
          <button class="btn btn-secondary btn-sm" id="client-modal-cancel">Annuleren</button>
          <button class="btn btn-primary btn-sm" id="client-modal-save" style="width: auto">
            Opslaan
          </button>
        </div>
      </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal-backdrop hidden" id="feedback-modal">
      <div class="modal">
        <h3>Send Feedback</h3>
        <div id="feedback-modal-error" class="error-msg"></div>
        <div class="form-group">
          <label for="feedback-subject">Subject *</label>
          <input type="text" id="feedback-subject" maxlength="255" placeholder="e.g. Bug report, Feature request..." />
        </div>
        <div class="form-group">
          <label for="feedback-message">Message *</label>
          <textarea id="feedback-message" maxlength="5000" placeholder="Describe your feedback..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary btn-sm" id="feedback-modal-cancel">Cancel</button>
          <button class="btn btn-primary btn-sm" id="feedback-modal-send" style="width: auto">
            Send Feedback
          </button>
        </div>
      </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
      (function () {
        'use strict';

        // ── State ──
        let accessToken = null;
        let refreshToken = localStorage.getItem('appfactory_refresh_token');
        let currentUser = null;
        let currentSort = { field: 'name', order: 'asc' };
        let currentPage = 1;
        let currentLimit = 20;
        let searchDebounce = null;
        let selectedUserId = null;
        let allRoles = [];

        // Portfolio / Project state
        let projectEnums = null;
        let allProjectsData = [];
        let editingProjectId = null;
        let projSearchDebounce = null;

        // Client state
        let clients = [];
        let editingClientId = null;
        let showInactiveClients = false;
        let clientsSearchTerm = '';
        let clientsSearchDebounce = null;
        let clientsSortField = 'code';
        let clientsSortOrder = 'asc';
        let clientsPage = 1;
        let clientsPerPage = 20;
        let allClientsData = [];

        // ── DOM refs ──
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-btn');

        // ── API helper ──
        async function apiFetch(url, opts = {}) {
          const headers = { 'Content-Type': 'application/json', ...opts.headers };
          if (accessToken) headers['Authorization'] = 'Bearer ' + accessToken;

          let res = await fetch(url, { ...opts, headers });

          // Auto-refresh on 401
          if (res.status === 401 && refreshToken && !url.includes('/api/auth/')) {
            const refreshed = await tryRefresh();
            if (refreshed) {
              headers['Authorization'] = 'Bearer ' + accessToken;
              res = await fetch(url, { ...opts, headers });
            } else {
              doLogout();
              throw new Error('Session expired');
            }
          }

          return res;
        }

        async function tryRefresh() {
          try {
            const res = await fetch('/api/auth/refresh', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ refreshToken }),
            });
            if (!res.ok) return false;
            const data = await res.json();
            accessToken = data.accessToken;
            refreshToken = data.refreshToken;
            localStorage.setItem('appfactory_refresh_token', refreshToken);
            return true;
          } catch {
            return false;
          }
        }

        // ── Toast ──
        function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = 'toast toast-' + type + ' visible';
          setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        // ── Login ──
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value;

          if (!name || !password) {
            showLoginError('Please enter username and password');
            return;
          }

          loginBtn.disabled = true;
          loginBtn.textContent = 'Signing in...';
          hideLoginError();

          try {
            const res = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, password }),
            });

            const data = await res.json();

            if (!res.ok) {
              showLoginError(data.error?.message || 'Login failed');
              return;
            }

            accessToken = data.accessToken;
            refreshToken = data.refreshToken;
            localStorage.setItem('appfactory_refresh_token', refreshToken);
            currentUser = data.user;
            enterApp();
          } catch (err) {
            showLoginError('Network error. Please try again.');
          } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
          }
        });

        function showLoginError(msg) {
          loginError.textContent = msg;
          loginError.classList.add('visible');
        }
        function hideLoginError() {
          loginError.classList.remove('visible');
        }

        // ── Sidebar Toggle ──
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.querySelector('.sidebar');
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
        });

        // ── Top Bar Dropdown ──
        const topBarDropdown = document.getElementById('top-bar-dropdown');
        document.addEventListener('click', () => {
          topBarDropdown.classList.add('hidden');
        });
        topBarDropdown.addEventListener('click', (e) => e.stopPropagation());
        document.getElementById('top-bar-security').addEventListener('click', () => {
          topBarDropdown.classList.add('hidden');
          document.querySelectorAll('.nav-item').forEach((n) => n.classList.remove('active'));
          showTwoFactorSetupView();
        });
        document.getElementById('top-bar-logout').addEventListener('click', () => {
          topBarDropdown.classList.add('hidden');
          doLogout();
        });

        // ── Logout ──
        document.getElementById('logout-btn').addEventListener('click', doLogout);

        async function doLogout() {
          if (refreshToken) {
            try {
              await fetch('/api/auth/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken }),
              });
            } catch {
              /* ignore */
            }
          }
          accessToken = null;
          refreshToken = null;
          currentUser = null;
          localStorage.removeItem('appfactory_refresh_token');
          appView.classList.remove('active');
          loginView.style.display = 'flex';
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
          hideLoginError();
        }

        // ── Enter App ──
        async function enterApp() {
          loginView.style.display = 'none';
          appView.classList.add('active');

          // User info in sidebar
          const initials = (currentUser.fullName || currentUser.name)
            .split(' ')
            .map((w) => w[0])
            .join('')
            .toUpperCase()
            .slice(0, 2);
          document.getElementById('user-avatar').textContent = initials;
          document.getElementById('user-display-name').textContent =
            currentUser.fullName || currentUser.name;
          document.getElementById('user-display-role').textContent = currentUser.roles
            .map((r) => r.name)
            .join(', ');

          // Load navigation
          loadNavigation();

          const isAdmin =
            currentUser &&
            currentUser.roles &&
            currentUser.roles.some((r) => r.name === 'Administrator');

          if (isAdmin) {
            loadRoles();
          }

          // Always show homepage/dashboard first
          showDashboardView();

          // Wire up module card clicks
          document.querySelectorAll('.module-card').forEach((card) => {
            card.addEventListener('click', () => {
              const mod = card.dataset.module;
              if (mod === 'portfolio') {
                showPortfolioView();
                // Highlight Portfolio in sidebar
                document.querySelectorAll('.nav-item').forEach((n) => {
                  n.classList.toggle('active', n.textContent === 'Portfolio');
                });
              } else {
                showToast(card.querySelector('h3').textContent + ' module coming soon');
              }
            });
          });
        }

        // ── Navigation ──
        function loadNavigation() {
          const nav = document.getElementById('sidebar-nav');
          nav.innerHTML = '';

          const isAdmin =
            currentUser &&
            currentUser.roles &&
            currentUser.roles.some((r) => r.name === 'Administrator');

          const items = [];

          // Homepage for all users (always first, always default active)
          items.push({ label: 'Homepage', icon: 'H', view: 'dashboard', active: true });

          // Users for admin only
          if (isAdmin) {
            items.push({ label: 'Users', icon: 'U', view: 'users', active: false });
          }

          // Portfolio for all authenticated users
          items.push({ label: 'Portfolio', icon: 'P', view: 'portfolio', active: false });

          // Klanten for admin/manager
          const isManager =
            currentUser &&
            currentUser.roles &&
            currentUser.roles.some((r) => r.name === 'Manager');
          if (isAdmin || isManager) {
            items.push({ label: 'Klanten', icon: 'K', view: 'clients', active: false });
          }

          items.forEach((item) => {
            const el = document.createElement('div');
            el.className = 'nav-item' + (item.active ? ' active' : '');
            el.textContent = item.label;
            if (item.href) {
              el.addEventListener('click', () => window.open(item.href, '_blank'));
            } else {
              el.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach((n) => n.classList.remove('active'));
                el.classList.add('active');
                if (item.view === 'dashboard') {
                  showDashboardView();
                } else if (item.view === 'users') {
                  showUsersView();
                } else if (item.view === 'clients') {
                  showClientsView();
                } else if (item.view === 'portfolio') {
                  showPortfolioView();
                }
              });
            }
            nav.appendChild(el);
          });
        }

        // ── View Management ──
        function hideAllViews() {
          document.getElementById('list-view').classList.add('hidden');
          ['detail-view', 'create-view', 'dashboard-view', 'clients-view', 'portfolio-view', 'project-form-view'].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) el.classList.remove('active');
          });
          document.getElementById('users-view').style.display = 'none';
        }

        function showDashboardView() {
          hideAllViews();
          document.getElementById('dashboard-view').classList.add('active');
        }

        function showUsersView() {
          hideAllViews();
          document.getElementById('users-view').style.display = '';
          document.getElementById('list-view').classList.remove('hidden');
          loadRoles();
          loadUsers();
        }

        // ── Clients View ──
        function showClientsView() {
          hideAllViews();
          document.getElementById('clients-view').classList.add('active');
          loadClients();
        }

        // ── Portfolio View ──
        function showPortfolioView() {
          hideAllViews();
          document.getElementById('portfolio-view').classList.add('active');
          loadProjectEnums().then(function () {
            loadProjects();
          });
        }

        function showProjectFormView(projectId) {
          hideAllViews();
          document.getElementById('project-form-view').classList.add('active');
          editingProjectId = projectId || null;
          document.getElementById('project-form-error').textContent = '';
          document.getElementById('project-form-title').textContent = projectId ? 'Edit project' : 'New project';
          document.getElementById('proj-breadcrumb-current').textContent = projectId ? 'Edit project' : 'New project';
          document.getElementById('project-delete-btn').style.display = projectId ? '' : 'none';

          // Reset form
          ['pf-name','pf-reference','pf-governance-template','pf-infra-template','pf-ops-template','pf-start-date','pf-go-live-date','pf-description'].forEach(function(id) {
            document.getElementById(id).value = '';
          });
          ['pf-department','pf-team','pf-master-project','pf-domain','pf-process','pf-app-size','pf-complexity','pf-alert-level','pf-governance-status'].forEach(function(id) {
            document.getElementById(id).value = '';
          });

          // Load form dropdowns
          loadProjectFormDropdowns(projectId);
        }

        async function loadProjectEnums() {
          if (projectEnums) return;
          try {
            var res = await apiFetch('/api/projects/enums');
            if (res.ok) {
              projectEnums = await res.json();
              populateProjectFilterDropdowns();
            }
          } catch (e) { /* ignore */ }
        }

        function populateProjectFilterDropdowns() {
          if (!projectEnums) return;
          var statusSel = document.getElementById('proj-filter-status');
          statusSel.innerHTML = '<option value="">All</option>';
          projectEnums.statuses.forEach(function (s) {
            statusSel.innerHTML += '<option value="' + s + '">' + s + '</option>';
          });
          var domainSel = document.getElementById('proj-filter-domain');
          domainSel.innerHTML = '<option value="">All</option>';
          projectEnums.domains.forEach(function (d) {
            domainSel.innerHTML += '<option value="' + d + '">' + d + '</option>';
          });
          var alertSel = document.getElementById('proj-filter-alert');
          alertSel.innerHTML = '<option value="">All</option>';
          projectEnums.alertLevels.forEach(function (a) {
            alertSel.innerHTML += '<option value="' + a + '">' + a + '</option>';
          });
          var govSel = document.getElementById('proj-filter-governance');
          govSel.innerHTML = '<option value="">All</option>';
          projectEnums.governanceStatuses.forEach(function (g) {
            govSel.innerHTML += '<option value="' + g + '">' + g + '</option>';
          });
        }

        async function loadProjects() {
          var tbody = document.getElementById('proj-table-body');
          tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';
          try {
            var params = new URLSearchParams();
            var search = document.getElementById('proj-search').value.trim();
            if (search) params.set('search', search);
            var status = document.getElementById('proj-filter-status').value;
            if (status) params.set('status', status);
            var domain = document.getElementById('proj-filter-domain').value;
            if (domain) params.set('domain', domain);
            var alertLevel = document.getElementById('proj-filter-alert').value;
            if (alertLevel) params.set('alertLevel', alertLevel);
            var governance = document.getElementById('proj-filter-governance').value;
            if (governance) params.set('governanceStatus', governance);

            var res = await apiFetch('/api/projects?' + params.toString());
            if (!res.ok) throw new Error('Failed');
            allProjectsData = await res.json();
            renderProjectTable(allProjectsData);
          } catch (e) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Failed to load projects</td></tr>';
          }
        }

        function renderProjectTable(projects) {
          var tbody = document.getElementById('proj-table-body');
          // Apply local column text filters
          var nameFilter = (document.getElementById('proj-filter-name').value || '').toLowerCase();
          var deptFilter = (document.getElementById('proj-filter-dept').value || '').toLowerCase();
          var teamFilter = (document.getElementById('proj-filter-team').value || '').toLowerCase();
          var filtered = projects.filter(function (p) {
            if (nameFilter && (p.name || '').toLowerCase().indexOf(nameFilter) === -1) return false;
            if (deptFilter && (p.departmentName || '').toLowerCase().indexOf(deptFilter) === -1) return false;
            if (teamFilter && (p.teamName || '').toLowerCase().indexOf(teamFilter) === -1) return false;
            return true;
          });

          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No projects found</td></tr>';
            return;
          }

          tbody.innerHTML = filtered.map(function (p) {
            var statusClass = (p.status || '').toLowerCase().replace(/\s+/g, '-');
            var alertClass = (p.alertLevel || '').toLowerCase();
            return '<tr data-id="' + p.id + '" style="cursor:pointer">' +
              '<td><strong>' + esc(p.name) + '</strong></td>' +
              '<td><span class="proj-status-badge ' + statusClass + '">' + esc(p.status || '-') + '</span></td>' +
              '<td>' + esc(p.departmentName || '-') + '</td>' +
              '<td>' + esc(p.teamName || '-') + '</td>' +
              '<td>' + esc(p.domain || '-') + '</td>' +
              '<td>' + (p.alertLevel ? '<span class="proj-alert-dot ' + alertClass + '"></span>' + esc(p.alertLevel) : '-') + '</td>' +
              '<td>' + esc(p.governanceStatus || '-') + '</td>' +
              '</tr>';
          }).join('');

          // Row click to edit
          tbody.querySelectorAll('tr[data-id]').forEach(function (row) {
            row.addEventListener('click', function () {
              showProjectFormView(row.dataset.id);
            });
          });
        }

        async function loadProjectFormDropdowns(projectId) {
          await loadProjectEnums();

          // Populate enum dropdowns
          var statusSel = document.getElementById('pf-status');
          statusSel.innerHTML = '';
          (projectEnums.statuses || []).forEach(function (s) {
            statusSel.innerHTML += '<option value="' + s + '">' + s + '</option>';
          });

          function fillEnum(selId, arr) {
            var sel = document.getElementById(selId);
            sel.innerHTML = '<option value="">-- Select --</option>';
            (arr || []).forEach(function (v) {
              sel.innerHTML += '<option value="' + v + '">' + v + '</option>';
            });
          }
          fillEnum('pf-domain', projectEnums.domains);
          fillEnum('pf-process', projectEnums.processes);
          fillEnum('pf-app-size', projectEnums.appSizes);
          fillEnum('pf-complexity', projectEnums.complexities);
          fillEnum('pf-alert-level', projectEnums.alertLevels);
          fillEnum('pf-governance-status', projectEnums.governanceStatuses);

          // Load departments
          try {
            var deptRes = await apiFetch('/api/departments');
            var deptSel = document.getElementById('pf-department');
            deptSel.innerHTML = '<option value="">-- Select --</option>';
            if (deptRes.ok) {
              var depts = await deptRes.json();
              depts.forEach(function (d) {
                deptSel.innerHTML += '<option value="' + d.id + '">' + esc(d.name) + '</option>';
              });
            }
          } catch (e) { /* ignore */ }

          // Load teams (dependent on department)
          async function loadTeamsForDept(deptId) {
            var teamSel = document.getElementById('pf-team');
            teamSel.innerHTML = '<option value="">-- Select --</option>';
            if (!deptId) return;
            try {
              var teamRes = await apiFetch('/api/teams?departmentId=' + deptId);
              if (teamRes.ok) {
                var teams = await teamRes.json();
                teams.forEach(function (t) {
                  teamSel.innerHTML += '<option value="' + t.id + '">' + esc(t.name) + '</option>';
                });
              }
            } catch (e) { /* ignore */ }
          }

          document.getElementById('pf-department').addEventListener('change', function () {
            loadTeamsForDept(this.value);
          });

          // Load existing projects for master project dropdown
          try {
            var projRes = await apiFetch('/api/projects');
            var masterSel = document.getElementById('pf-master-project');
            masterSel.innerHTML = '<option value="">-- None --</option>';
            if (projRes.ok) {
              var projs = await projRes.json();
              projs.forEach(function (p) {
                if (p.id !== projectId) {
                  masterSel.innerHTML += '<option value="' + p.id + '">' + esc(p.name) + '</option>';
                }
              });
            }
          } catch (e) { /* ignore */ }

          // If editing, load project data
          if (projectId) {
            try {
              var pRes = await apiFetch('/api/projects/' + projectId);
              if (pRes.ok) {
                var p = await pRes.json();
                document.getElementById('pf-name').value = p.name || '';
                document.getElementById('pf-reference').value = p.referenceNumber || '';
                document.getElementById('pf-department').value = p.departmentId || '';
                await loadTeamsForDept(p.departmentId);
                document.getElementById('pf-team').value = p.teamId || '';
                document.getElementById('pf-master-project').value = p.masterProjectId || '';
                document.getElementById('pf-status').value = p.status || 'Intake';
                document.getElementById('pf-domain').value = p.domain || '';
                document.getElementById('pf-process').value = p.process || '';
                document.getElementById('pf-app-size').value = p.appSize || '';
                document.getElementById('pf-complexity').value = p.complexity || '';
                document.getElementById('pf-alert-level').value = p.alertLevel || '';
                document.getElementById('pf-governance-status').value = p.governanceStatus || '';
                document.getElementById('pf-governance-template').value = p.governanceTemplate || '';
                document.getElementById('pf-infra-template').value = p.infrastructureTemplate || '';
                document.getElementById('pf-ops-template').value = p.operationsTemplate || '';
                document.getElementById('pf-start-date').value = p.startDate || '';
                document.getElementById('pf-go-live-date').value = p.goLiveDate || '';
                document.getElementById('pf-description').value = p.description || '';
              }
            } catch (e) { /* ignore */ }
          }
        }

        async function saveProject() {
          var errEl = document.getElementById('project-form-error');
          errEl.textContent = '';
          var name = document.getElementById('pf-name').value.trim();
          if (!name) {
            errEl.textContent = 'Project name is required';
            return;
          }
          var body = {
            name: name,
            referenceNumber: document.getElementById('pf-reference').value.trim() || null,
            departmentId: document.getElementById('pf-department').value || null,
            teamId: document.getElementById('pf-team').value || null,
            masterProjectId: document.getElementById('pf-master-project').value || null,
            status: document.getElementById('pf-status').value || 'Intake',
            domain: document.getElementById('pf-domain').value || null,
            process: document.getElementById('pf-process').value || null,
            appSize: document.getElementById('pf-app-size').value || null,
            complexity: document.getElementById('pf-complexity').value || null,
            alertLevel: document.getElementById('pf-alert-level').value || null,
            governanceStatus: document.getElementById('pf-governance-status').value || null,
            governanceTemplate: document.getElementById('pf-governance-template').value.trim() || null,
            infrastructureTemplate: document.getElementById('pf-infra-template').value.trim() || null,
            operationsTemplate: document.getElementById('pf-ops-template').value.trim() || null,
            startDate: document.getElementById('pf-start-date').value || null,
            goLiveDate: document.getElementById('pf-go-live-date').value || null,
            description: document.getElementById('pf-description').value.trim() || null,
          };

          try {
            var res;
            if (editingProjectId) {
              res = await apiFetch('/api/projects/' + editingProjectId, {
                method: 'PUT',
                body: JSON.stringify(body),
              });
            } else {
              res = await apiFetch('/api/projects', {
                method: 'POST',
                body: JSON.stringify(body),
              });
            }
            if (!res.ok) {
              var err = await res.json();
              errEl.textContent = err.error || 'Failed to save project';
              return;
            }
            showToast(editingProjectId ? 'Project updated' : 'Project created', 'success');
            showPortfolioView();
          } catch (e) {
            errEl.textContent = 'Network error';
          }
        }

        async function deleteProject(id) {
          if (!confirm('Are you sure you want to delete this project?')) return;
          try {
            var res = await apiFetch('/api/projects/' + id, { method: 'DELETE' });
            if (!res.ok) {
              var err = await res.json();
              showToast(err.error || 'Failed to delete project', 'error');
              return;
            }
            showToast('Project deleted', 'success');
            showPortfolioView();
          } catch (e) {
            showToast('Network error', 'error');
          }
        }

        function showListView() {
          hideAllViews();
          document.getElementById('users-view').style.display = '';
          document.getElementById('list-view').classList.remove('hidden');
          selectedUserId = null;
        }

        // ── 2FA Setup (placeholder) ──
        function showTwoFactorSetupView() {
          hideAllViews();
          // Placeholder: 2FA setup will be implemented later
          showToast('Security settings coming soon', 'error');
        }

        // ── Load Roles (shared) ──
        async function loadRoles() {
          try {
            const res = await apiFetch('/api/roles');
            if (!res.ok) return;
            allRoles = await res.json();

            // Populate filter dropdown
            const select = document.getElementById('filter-role');
            // Clear existing options except the first
            while (select.options.length > 1) select.remove(1);
            allRoles.forEach((role) => {
              const opt = document.createElement('option');
              opt.value = role.name;
              opt.textContent = role.name;
              select.appendChild(opt);
            });
          } catch {
            /* ignore */
          }
        }

        // ── User List ──
        async function loadUsers() {
          const tbody = document.getElementById('user-table-body');
          tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';

          const params = new URLSearchParams();
          params.set('page', currentPage);
          params.set('limit', currentLimit);
          params.set('sortBy', currentSort.field);
          params.set('order', currentSort.order);

          const search = document.getElementById('search-input').value.trim();
          if (search) params.set('search', search);

          const active = document.getElementById('filter-active').value;
          if (active) params.set('active', active);

          const type = document.getElementById('filter-type').value;
          if (type === 'local') params.set('isLocalUser', 'true');
          else if (type === 'webservice') params.set('webServiceUser', 'true');

          const role = document.getElementById('filter-role').value;
          if (role) params.set('role', role);

          try {
            const res = await apiFetch('/api/users?' + params.toString());
            if (!res.ok) throw new Error('Failed to load users');
            const result = await res.json();

            renderUserTable(result.data);
            renderPagination(result.pagination);
          } catch (err) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state">Failed to load users</td></tr>';
          }
        }

        function renderUserTable(users) {
          const tbody = document.getElementById('user-table-body');

          if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
            return;
          }

          tbody.innerHTML = users
            .map(
              (u) => `
      <tr data-id="${u.id}">
        <td><strong>${esc(u.name)}</strong></td>
        <td>${esc(u.fullName || '-')}</td>
        <td>${esc(u.email || '-')}</td>
        <td>
          ${
            u.blocked
              ? '<span class="badge badge-blocked">Blocked</span>'
              : u.active
                ? '<span class="badge badge-active">Active</span>'
                : '<span class="badge badge-inactive">Inactive</span>'
          }
        </td>
        <td>
          ${
            u.webServiceUser
              ? '<span class="badge badge-ws">Web Service</span>'
              : u.isLocalUser
                ? 'Local'
                : 'External'
          }
        </td>
        <td>${u.lastLogin ? formatDate(u.lastLogin) : 'Never'}</td>
      </tr>
    `
            )
            .join('');

          // Click handlers
          tbody.querySelectorAll('tr[data-id]').forEach((tr) => {
            tr.addEventListener('click', () => showUserDetail(tr.dataset.id));
          });
        }

        function renderPagination(p) {
          document.getElementById('pagination-info').textContent =
            p.total === 0
              ? 'No results'
              : `Showing ${(p.page - 1) * p.limit + 1}-${Math.min(p.page * p.limit, p.total)} of ${p.total}`;
          document.getElementById('page-indicator').textContent =
            p.totalPages > 0 ? `Page ${p.page} of ${p.totalPages}` : '';
          document.getElementById('prev-page').disabled = p.page <= 1;
          document.getElementById('next-page').disabled = p.page >= p.totalPages;
        }

        // Sorting
        document.querySelectorAll('#users-view th[data-sort]').forEach((th) => {
          th.addEventListener('click', () => {
            const field = th.dataset.sort;
            if (currentSort.field === field) {
              currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
              currentSort.field = field;
              currentSort.order = 'asc';
            }
            updateSortArrows();
            currentPage = 1;
            loadUsers();
          });
        });

        function updateSortArrows() {
          document.querySelectorAll('#users-view th[data-sort]').forEach((th) => {
            const arrow = th.querySelector('.sort-arrow');
            if (!arrow) return;
            if (th.dataset.sort === currentSort.field) {
              arrow.textContent = currentSort.order === 'asc' ? '\u25B2' : '\u25BC';
            } else {
              arrow.textContent = '';
            }
          });
        }
        updateSortArrows();

        // Search
        document.getElementById('search-input').addEventListener('input', () => {
          clearTimeout(searchDebounce);
          searchDebounce = setTimeout(() => {
            currentPage = 1;
            loadUsers();
          }, 300);
        });

        // Filters
        ['filter-active', 'filter-type', 'filter-role'].forEach((id) => {
          document.getElementById(id).addEventListener('change', () => {
            currentPage = 1;
            loadUsers();
          });
        });

        // Pagination
        document.getElementById('prev-page').addEventListener('click', () => {
          currentPage--;
          loadUsers();
        });
        document.getElementById('next-page').addEventListener('click', () => {
          currentPage++;
          loadUsers();
        });
        document.getElementById('page-size').addEventListener('change', (e) => {
          currentLimit = parseInt(e.target.value);
          currentPage = 1;
          loadUsers();
        });

        // ── User Detail ──
        async function showUserDetail(id) {
          selectedUserId = id;
          try {
            const res = await apiFetch('/api/users/' + id);
            if (!res.ok) throw new Error('User not found');
            const user = await res.json();
            renderDetail(user);
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('active');
          } catch (err) {
            showToast('Failed to load user details', 'error');
          }
        }

        function renderDetail(user) {
          document.getElementById('detail-title').textContent = user.fullName || user.name;
          document.getElementById('detail-name').value = user.name;
          document.getElementById('detail-fullname').value = user.fullName || '';
          document.getElementById('detail-email').value = user.email || '';
          document.getElementById('detail-id').textContent = user.id;
          document.getElementById('detail-user-type').textContent =
            user.userType + (user.webServiceUser ? ' (Web Service)' : '');
          document.getElementById('detail-created').textContent = formatDate(user.createdAt);
          document.getElementById('detail-last-login').textContent = user.lastLogin
            ? formatDate(user.lastLogin)
            : 'Never';
          document.getElementById('detail-failed-logins').textContent = user.failedLogins;
          document.getElementById('temp-password').textContent = '';

          // Status
          const activeEl = document.getElementById('detail-active');
          activeEl.innerHTML = user.active
            ? '<span class="badge badge-active">Active</span>'
            : '<span class="badge badge-inactive">Inactive</span>';

          const blockedEl = document.getElementById('detail-blocked');
          blockedEl.innerHTML = user.blocked
            ? '<span class="badge badge-blocked">Blocked</span>' +
              (user.blockedSince ? ' since ' + formatDate(user.blockedSince) : '')
            : '<span style="color:var(--text-muted)">No</span>';

          document.getElementById('unblock-btn').style.display = user.blocked ? '' : 'none';
          document.getElementById('activate-btn').style.display = user.active ? 'none' : '';
          document.getElementById('deactivate-btn').style.display = user.active ? '' : 'none';

          // Roles
          const rolesEl = document.getElementById('detail-roles');
          if (user.roles && user.roles.length > 0) {
            rolesEl.innerHTML = user.roles
              .map((r) => '<span class="role-chip">' + esc(r.name) + '</span>')
              .join('');
          } else {
            rolesEl.innerHTML = '<span style="color:var(--text-muted)">No roles assigned</span>';
          }
        }

        // Back button
        document.getElementById('back-btn').addEventListener('click', showListView);

        // ── Save profile ──
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
          const fullName = document.getElementById('detail-fullname').value.trim();
          const email = document.getElementById('detail-email').value.trim();

          try {
            const res = await apiFetch('/api/users/' + selectedUserId, {
              method: 'PUT',
              body: JSON.stringify({ fullName: fullName || null, email: email || null }),
            });
            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || 'Failed to save');
            }
            const user = await res.json();
            renderDetail(user);
            showToast('Profile saved');
            loadUsers();
          } catch (err) {
            showToast(err.message, 'error');
          }
        });

        // ── Activate/Deactivate ──
        document
          .getElementById('activate-btn')
          .addEventListener('click', () => updateStatus({ active: true }));
        document
          .getElementById('deactivate-btn')
          .addEventListener('click', () => updateStatus({ active: false }));
        document
          .getElementById('unblock-btn')
          .addEventListener('click', () => updateStatus({ blocked: false }));

        async function updateStatus(body) {
          try {
            const res = await apiFetch('/api/users/' + selectedUserId + '/status', {
              method: 'PATCH',
              body: JSON.stringify(body),
            });
            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || 'Failed to update');
            }
            const user = await res.json();
            renderDetail(user);
            showToast('Status updated');
            loadUsers();
          } catch (err) {
            showToast(err.message, 'error');
          }
        }

        // ── Reset password (temporary) ──
        document.getElementById('reset-pw-btn').addEventListener('click', async () => {
          try {
            const res = await apiFetch('/api/users/' + selectedUserId + '/reset-password', {
              method: 'POST',
            });
            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || 'Failed to reset');
            }
            const data = await res.json();
            document.getElementById('temp-password').textContent = data.temporaryPassword;
            showToast('Password reset');
          } catch (err) {
            showToast(err.message, 'error');
          }
        });

        // ── Change Password Modal ──
        document.getElementById('change-pw-btn').addEventListener('click', () => {
          document.getElementById('pw-new').value = '';
          document.getElementById('pw-confirm').value = '';
          document.getElementById('pw-modal-error').classList.remove('visible');
          document.getElementById('password-modal').classList.remove('hidden');
        });
        document.getElementById('pw-modal-cancel').addEventListener('click', () => {
          document.getElementById('password-modal').classList.add('hidden');
        });
        document.getElementById('pw-modal-save').addEventListener('click', async () => {
          const newPassword = document.getElementById('pw-new').value;
          const confirmPassword = document.getElementById('pw-confirm').value;
          const errEl = document.getElementById('pw-modal-error');

          if (!newPassword || !confirmPassword) {
            errEl.textContent = 'Both fields are required';
            errEl.classList.add('visible');
            return;
          }
          if (newPassword !== confirmPassword) {
            errEl.textContent = 'Passwords do not match';
            errEl.classList.add('visible');
            return;
          }

          try {
            const res = await apiFetch('/api/users/' + selectedUserId + '/password', {
              method: 'PUT',
              body: JSON.stringify({ newPassword, confirmPassword }),
            });
            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || 'Failed to change password');
            }
            document.getElementById('password-modal').classList.add('hidden');
            showToast('Password changed');
          } catch (err) {
            errEl.textContent = err.message;
            errEl.classList.add('visible');
          }
        });

        // ── Edit Roles Modal ──
        document.getElementById('edit-roles-btn').addEventListener('click', async () => {
          // Get current user's roles
          const res = await apiFetch('/api/users/' + selectedUserId);
          if (!res.ok) return;
          const user = await res.json();
          const currentRoleIds = new Set(user.roles.map((r) => r.id));

          const container = document.getElementById('roles-modal-list');
          container.innerHTML = allRoles
            .map((r) => {
              const checked = currentRoleIds.has(r.id) ? 'checked' : '';
              return `<label class="checkbox-chip ${checked}" data-role-id="${r.id}">
        <input type="checkbox" value="${r.id}" ${checked}> ${esc(r.name)}
      </label>`;
            })
            .join('');

          // Toggle chip styling
          container.querySelectorAll('.checkbox-chip').forEach((chip) => {
            chip.addEventListener('click', (e) => {
              if (e.target.tagName === 'INPUT') return;
              const cb = chip.querySelector('input');
              cb.checked = !cb.checked;
              chip.classList.toggle('checked', cb.checked);
            });
            chip.querySelector('input').addEventListener('change', () => {
              chip.classList.toggle('checked', chip.querySelector('input').checked);
            });
          });

          document.getElementById('roles-modal').classList.remove('hidden');
        });

        document.getElementById('roles-modal-cancel').addEventListener('click', () => {
          document.getElementById('roles-modal').classList.add('hidden');
        });

        document.getElementById('roles-modal-save').addEventListener('click', async () => {
          const checkboxes = document.querySelectorAll(
            '#roles-modal-list input[type="checkbox"]:checked'
          );
          const roleIds = Array.from(checkboxes).map((cb) => cb.value);

          try {
            const res = await apiFetch('/api/users/' + selectedUserId + '/roles', {
              method: 'PUT',
              body: JSON.stringify({ roleIds }),
            });
            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || 'Failed to update roles');
            }
            const user = await res.json();
            renderDetail(user);
            document.getElementById('roles-modal').classList.add('hidden');
            showToast('Roles updated');
            loadUsers();
          } catch (err) {
            showToast(err.message, 'error');
          }
        });

        // ── Create User ──
        document.getElementById('new-user-btn').addEventListener('click', showCreateView);
        document.getElementById('create-back-btn').addEventListener('click', showListView);
        document.getElementById('create-cancel-btn').addEventListener('click', showListView);

        // Toggle email field for web service users
        document.querySelectorAll('input[name="user-type"]').forEach((radio) => {
          radio.addEventListener('change', () => {
            const isWs = document.getElementById('type-webservice').checked;
            document.getElementById('create-email-group').style.display = isWs ? 'none' : '';
            document.getElementById('create-subtitle').textContent = isWs
              ? 'Create an API-only web service account'
              : 'Create a new local user account';
          });
        });

        function showCreateView() {
          // Reset form
          document.getElementById('create-name').value = '';
          document.getElementById('create-password').value = '';
          document.getElementById('create-confirm').value = '';
          document.getElementById('create-fullname').value = '';
          document.getElementById('create-email').value = '';
          document.getElementById('type-local').checked = true;
          document.getElementById('create-email-group').style.display = '';
          document.getElementById('create-subtitle').textContent =
            'Create a new local user account';
          document.getElementById('create-error').classList.remove('visible');

          // Render role checkboxes
          const container = document.getElementById('create-roles');
          container.innerHTML = allRoles
            .map(
              (r) =>
                `<label class="checkbox-chip" data-role-id="${r.id}">
        <input type="checkbox" value="${r.id}"> ${esc(r.name)}
      </label>`
            )
            .join('');

          container.querySelectorAll('.checkbox-chip').forEach((chip) => {
            chip.addEventListener('click', (e) => {
              if (e.target.tagName === 'INPUT') return;
              const cb = chip.querySelector('input');
              cb.checked = !cb.checked;
              chip.classList.toggle('checked', cb.checked);
            });
            chip.querySelector('input').addEventListener('change', () => {
              chip.classList.toggle('checked', chip.querySelector('input').checked);
            });
          });

          document.getElementById('list-view').classList.add('hidden');
          document.getElementById('detail-view').classList.remove('active');
          document.getElementById('create-view').classList.add('active');
        }

        document.getElementById('create-submit-btn').addEventListener('click', async () => {
          const errEl = document.getElementById('create-error');
          errEl.classList.remove('visible');

          const isWebService = document.getElementById('type-webservice').checked;
          const name = document.getElementById('create-name').value.trim();
          const password = document.getElementById('create-password').value;
          const confirmPw = document.getElementById('create-confirm').value;
          const fullName = document.getElementById('create-fullname').value.trim() || undefined;
          const email = !isWebService
            ? document.getElementById('create-email').value.trim() || undefined
            : undefined;

          // Client-side validation
          if (!name) {
            errEl.textContent = 'Username is required';
            errEl.classList.add('visible');
            return;
          }
          if (!password) {
            errEl.textContent = 'Password is required';
            errEl.classList.add('visible');
            return;
          }
          if (password !== confirmPw) {
            errEl.textContent = 'Passwords do not match';
            errEl.classList.add('visible');
            return;
          }

          const roleCheckboxes = document.querySelectorAll(
            '#create-roles input[type="checkbox"]:checked'
          );
          const roleIds = Array.from(roleCheckboxes).map((cb) => cb.value);

          const url = isWebService ? '/api/users/webservice' : '/api/users';
          const body = isWebService
            ? { name, password, fullName, roleIds: roleIds.length > 0 ? roleIds : undefined }
            : {
                name,
                password,
                fullName,
                email,
                roleIds: roleIds.length > 0 ? roleIds : undefined,
              };

          const btn = document.getElementById('create-submit-btn');
          btn.disabled = true;
          btn.textContent = 'Creating...';

          try {
            const res = await apiFetch(url, {
              method: 'POST',
              body: JSON.stringify(body),
            });

            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || 'Failed to create user');
            }

            const user = await res.json();
            showToast('User "' + user.name + '" created');
            showListView();
            loadUsers();
          } catch (err) {
            errEl.textContent = err.message;
            errEl.classList.add('visible');
          } finally {
            btn.disabled = false;
            btn.textContent = 'Create User';
          }
        });

        // ── Clients CRUD ──
        async function loadClients() {
          const tbody = document.getElementById('clients-table-body');
          tbody.innerHTML = '<tr><td colspan="5" class="loading">Laden...</td></tr>';

          try {
            // Build query params
            const params = [];
            if (!showInactiveClients) params.push('active=true');
            if (clientsSearchTerm) params.push('search=' + encodeURIComponent(clientsSearchTerm));
            const query = params.length > 0 ? '?' + params.join('&') : '';

            // Fetch clients and projects
            const [clientsRes, projectsRes] = await Promise.all([
              apiFetch('/api/clients' + query),
              apiFetch('/api/projects'),
            ]);

            if (!clientsRes.ok) throw new Error('Failed to load clients');
            allClientsData = await clientsRes.json();

            // Count projects per client
            const projectCounts = {};
            if (projectsRes.ok) {
              const allProjects = await projectsRes.json();
              allProjects.forEach((p) => {
                if (p.clientId) {
                  projectCounts[p.clientId] = (projectCounts[p.clientId] || 0) + 1;
                }
              });
            }

            // Sort clients
            allClientsData.sort((a, b) => {
              let aVal = a[clientsSortField];
              let bVal = b[clientsSortField];
              if (typeof aVal === 'string') aVal = aVal.toLowerCase();
              if (typeof bVal === 'string') bVal = bVal.toLowerCase();
              if (clientsSortOrder === 'asc') {
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
              } else {
                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
              }
            });

            // Pagination
            const totalPages = Math.ceil(allClientsData.length / clientsPerPage);
            const start = (clientsPage - 1) * clientsPerPage;
            const end = start + clientsPerPage;
            clients = allClientsData.slice(start, end);

            // Update sort indicators
            document.getElementById('sort-code-indicator').textContent =
              clientsSortField === 'code' ? (clientsSortOrder === 'asc' ? '\u25B2' : '\u25BC') : '';
            document.getElementById('sort-name-indicator').textContent =
              clientsSortField === 'name' ? (clientsSortOrder === 'asc' ? '\u25B2' : '\u25BC') : '';

            // Update pagination controls
            const paginationDiv = document.getElementById('clients-pagination');
            if (totalPages > 1) {
              paginationDiv.style.display = 'flex';
              document.getElementById('clients-page-info').textContent =
                'Pagina ' + clientsPage + ' van ' + totalPages;
              document.getElementById('clients-prev-page').disabled = clientsPage === 1;
              document.getElementById('clients-next-page').disabled = clientsPage === totalPages;
            } else {
              paginationDiv.style.display = 'none';
            }

            // Render table
            if (clients.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="5" class="empty-state">Geen klanten gevonden</td></tr>';
              return;
            }

            tbody.innerHTML = '';
            clients.forEach((client) => {
              const tr = document.createElement('tr');
              const projectCount = projectCounts[client.id] || 0;
              tr.innerHTML = `
          <td>${esc(client.code)}</td>
          <td>${esc(client.name)}</td>
          <td>${projectCount}</td>
          <td><span class="badge ${client.active ? 'badge-active' : 'badge-inactive'}">${client.active ? 'Actief' : 'Inactief'}</span></td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="editClient('${client.id}')">Bewerken</button>
            <button class="btn btn-sm ${client.active ? 'btn-danger' : 'btn-success'}" onclick="toggleClientActive('${client.id}', ${!client.active})">${client.active ? 'Deactiveren' : 'Activeren'}</button>
          </td>
        `;
              tbody.appendChild(tr);
            });
          } catch (err) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="empty-state">Fout bij laden: ' +
              esc(err.message) +
              '</td></tr>';
          }
        }

        window.editClient = async function (clientId) {
          const client = clients.find((c) => c.id === clientId);
          if (!client) return;

          editingClientId = clientId;
          document.getElementById('client-modal-title').textContent = 'Klant bewerken';
          document.getElementById('client-code').value = client.code;
          document.getElementById('client-code').disabled = true;
          document.getElementById('client-name').value = client.name;
          document.getElementById('client-active').checked = client.active;
          document.getElementById('client-delete-btn').style.display = 'inline-block';
          document.getElementById('client-modal-error').style.display = 'none';
          document.getElementById('client-modal-error').classList.remove('visible');
          document.getElementById('client-modal').classList.remove('hidden');
        };

        window.toggleClientActive = async function (clientId, activate) {
          try {
            const res = await apiFetch(
              '/api/clients/' + clientId + '/' + (activate ? 'activate' : 'deactivate'),
              { method: 'PATCH' }
            );
            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || data.message || 'Actie mislukt');
            }
            showToast('Klant ' + (activate ? 'geactiveerd' : 'gedeactiveerd'));
            loadClients();
          } catch (err) {
            showToast(err.message, 'error');
          }
        };

        document.getElementById('create-client-btn').addEventListener('click', () => {
          editingClientId = null;
          document.getElementById('client-modal-title').textContent = 'Nieuwe klant';
          document.getElementById('client-code').value = '';
          document.getElementById('client-code').disabled = false;
          document.getElementById('client-name').value = '';
          document.getElementById('client-active').checked = true;
          document.getElementById('client-delete-btn').style.display = 'none';
          document.getElementById('client-modal-error').style.display = 'none';
          document.getElementById('client-modal-error').classList.remove('visible');
          document.getElementById('client-modal').classList.remove('hidden');
        });

        document.getElementById('client-modal-cancel').addEventListener('click', () => {
          document.getElementById('client-modal').classList.add('hidden');
        });

        document.getElementById('client-modal-save').addEventListener('click', async () => {
          const code = document.getElementById('client-code').value.trim();
          const name = document.getElementById('client-name').value.trim();
          const active = document.getElementById('client-active').checked;
          const errorEl = document.getElementById('client-modal-error');

          if (!code || !name) {
            errorEl.textContent = 'Code en naam zijn verplicht';
            errorEl.style.display = 'block';
            errorEl.classList.add('visible');
            return;
          }

          try {
            let res;
            if (editingClientId) {
              res = await apiFetch('/api/clients/' + editingClientId, {
                method: 'PUT',
                body: JSON.stringify({ name }),
              });
            } else {
              res = await apiFetch('/api/clients', {
                method: 'POST',
                body: JSON.stringify({ code, name, active }),
              });
            }

            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.error?.message || data.message || 'Opslaan mislukt');
            }

            document.getElementById('client-modal').classList.add('hidden');
            showToast(editingClientId ? 'Klant bijgewerkt' : 'Klant aangemaakt');
            loadClients();
          } catch (err) {
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
            errorEl.classList.add('visible');
          }
        });

        document.getElementById('client-delete-btn').addEventListener('click', async () => {
          if (!confirm('Weet je zeker dat je deze klant wilt verwijderen?')) return;

          try {
            const res = await apiFetch('/api/clients/' + editingClientId, { method: 'DELETE' });
            if (!res.ok && res.status !== 204) {
              const data = await res.json();
              throw new Error(data.error?.message || data.message || 'Verwijderen mislukt');
            }
            document.getElementById('client-modal').classList.add('hidden');
            showToast('Klant verwijderd');
            loadClients();
          } catch (err) {
            const errorEl = document.getElementById('client-modal-error');
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
            errorEl.classList.add('visible');
          }
        });

        // ── Feedback modal ──
        document.getElementById('open-feedback-btn').addEventListener('click', function () {
          document.getElementById('feedback-subject').value = '';
          document.getElementById('feedback-message').value = '';
          document.getElementById('feedback-modal-error').style.display = 'none';
          document.getElementById('feedback-modal').classList.remove('hidden');
        });

        document.getElementById('feedback-modal-cancel').addEventListener('click', function () {
          document.getElementById('feedback-modal').classList.add('hidden');
        });

        document.getElementById('feedback-modal-send').addEventListener('click', async function () {
          var subject = document.getElementById('feedback-subject').value.trim();
          var message = document.getElementById('feedback-message').value.trim();
          var errorEl = document.getElementById('feedback-modal-error');

          if (!subject || !message) {
            errorEl.textContent = 'Subject and message are required';
            errorEl.style.display = 'block';
            errorEl.classList.add('visible');
            return;
          }

          try {
            var res = await apiFetch('/api/feedback', {
              method: 'POST',
              body: JSON.stringify({ subject: subject, message: message }),
            });

            if (!res.ok) {
              var data = await res.json();
              throw new Error(data.error?.message || data.message || 'Failed to send feedback');
            }

            document.getElementById('feedback-modal').classList.add('hidden');
            showToast('Thank you! Your feedback has been submitted.');
          } catch (err) {
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
            errorEl.classList.add('visible');
          }
        });

        document.getElementById('clients-show-inactive').addEventListener('change', (e) => {
          showInactiveClients = e.target.checked;
          clientsPage = 1;
          loadClients();
        });

        // Client search with debouncing
        document.getElementById('clients-search').addEventListener('input', (e) => {
          if (clientsSearchDebounce) clearTimeout(clientsSearchDebounce);
          clientsSearchDebounce = setTimeout(() => {
            clientsSearchTerm = e.target.value.trim();
            clientsPage = 1;
            loadClients();
          }, 300);
        });

        // Client sortable columns
        document.querySelectorAll('#clients-view th[data-sort]').forEach((th) => {
          th.addEventListener('click', () => {
            const sortField = th.getAttribute('data-sort');
            if (clientsSortField === sortField) {
              clientsSortOrder = clientsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
              clientsSortField = sortField;
              clientsSortOrder = 'asc';
            }
            loadClients();
          });
        });

        // Client pagination
        document.getElementById('clients-prev-page').addEventListener('click', () => {
          if (clientsPage > 1) {
            clientsPage--;
            loadClients();
          }
        });

        document.getElementById('clients-next-page').addEventListener('click', () => {
          const totalPages = Math.ceil(allClientsData.length / clientsPerPage);
          if (clientsPage < totalPages) {
            clientsPage++;
            loadClients();
          }
        });

        // ── Portfolio tab switching ──
        document.querySelectorAll('.portfolio-tab').forEach(function (tab) {
          tab.addEventListener('click', function () {
            if (tab.disabled) return;
            document.querySelectorAll('.portfolio-tab').forEach(function (t) { t.classList.remove('active'); });
            document.querySelectorAll('.portfolio-tab-panel').forEach(function (p) { p.classList.remove('active'); });
            tab.classList.add('active');
            var panel = document.querySelector('[data-panel="' + tab.dataset.tab + '"]');
            if (panel) panel.classList.add('active');

            // Load data for the active tab
            if (tab.dataset.tab === 'projects') loadProjects();
            if (tab.dataset.tab === 'open-tasks') loadOpenTasks();
            if (tab.dataset.tab === 'financial') loadFinancialData();
          });
        });

        function loadOpenTasks() {
          // Populate alert level filter from enums
          loadProjectEnums().then(function () {
            if (projectEnums) {
              var sel = document.getElementById('tasks-filter-alert');
              if (sel.options.length <= 1) {
                projectEnums.alertLevels.forEach(function (a) {
                  sel.innerHTML += '<option value="' + a + '">' + a + '</option>';
                });
              }
            }
          });
          // Open tasks: placeholder - show empty state
          document.getElementById('tasks-table-body').innerHTML = '';
          document.getElementById('tasks-empty-state').style.display = '';
        }

        function loadFinancialData() {
          // Populate department filter
          apiFetch('/api/departments').then(function (res) {
            if (!res.ok) return;
            return res.json();
          }).then(function (depts) {
            if (!depts) return;
            var sel = document.getElementById('fin-dept-filter');
            if (sel.options.length <= 1) {
              depts.forEach(function (d) {
                sel.innerHTML += '<option value="' + d.id + '">' + esc(d.name) + '</option>';
              });
            }
          }).catch(function () {});
          // Financial data: placeholder - show zeros
          document.getElementById('fin-capex').textContent = '0';
          document.getElementById('fin-opex').textContent = '0';
          document.getElementById('fin-investment').textContent = '0';
          document.getElementById('fin-ben-onetime').textContent = '0';
          document.getElementById('fin-ben-recurring').textContent = '0';
          document.getElementById('fin-table-body').innerHTML = '<tr><td colspan="7" class="empty-state">No financial data available</td></tr>';
        }

        // ── Portfolio event listeners ──
        document.getElementById('proj-search').addEventListener('input', function (e) {
          if (projSearchDebounce) clearTimeout(projSearchDebounce);
          projSearchDebounce = setTimeout(function () { loadProjects(); }, 300);
        });

        // Server-side filter dropdowns
        ['proj-filter-status', 'proj-filter-domain', 'proj-filter-alert', 'proj-filter-governance'].forEach(function (id) {
          document.getElementById(id).addEventListener('change', function () { loadProjects(); });
        });

        // Client-side column text filters
        ['proj-filter-name', 'proj-filter-dept', 'proj-filter-team'].forEach(function (id) {
          document.getElementById(id).addEventListener('input', function () {
            renderProjectTable(allProjectsData);
          });
        });

        document.getElementById('new-project-btn').addEventListener('click', function () {
          showProjectFormView(null);
        });

        document.getElementById('project-save-btn').addEventListener('click', saveProject);

        document.getElementById('project-cancel-btn').addEventListener('click', function () {
          showPortfolioView();
        });

        document.getElementById('project-delete-btn').addEventListener('click', function () {
          if (editingProjectId) deleteProject(editingProjectId);
        });

        document.getElementById('proj-breadcrumb-home').addEventListener('click', function () {
          showDashboardView();
          document.querySelectorAll('.nav-item').forEach(function (n) {
            n.classList.toggle('active', n.textContent === 'Homepage');
          });
        });

        document.getElementById('proj-breadcrumb-portfolio').addEventListener('click', function () {
          showPortfolioView();
        });

        // Export dropdown toggle
        document.getElementById('proj-export-btn').addEventListener('click', function (e) {
          e.stopPropagation();
          document.getElementById('proj-export-menu').classList.toggle('hidden');
        });
        document.getElementById('proj-export-menu').querySelectorAll('button').forEach(function (btn) {
          btn.addEventListener('click', function () {
            document.getElementById('proj-export-menu').classList.add('hidden');
            exportProjects(btn.dataset.format);
          });
        });

        function exportProjects(format) {
          if (!allProjectsData.length) {
            showToast('No projects to export', 'error');
            return;
          }
          var headers = ['Name','Status','Department','Team','Domain','Alert Level','Governance','Start Date','Go-Live Date'];
          var rows = allProjectsData.map(function (p) {
            return [p.name, p.status, p.departmentName||'', p.teamName||'', p.domain||'', p.alertLevel||'', p.governanceStatus||'', p.startDate||'', p.goLiveDate||''];
          });
          var csv = [headers.join(',')].concat(rows.map(function (r) {
            return r.map(function (c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(',');
          })).join('\n');

          var blob = new Blob([csv], { type: 'text/csv' });
          var a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'projects.' + (format === 'xlsx' ? 'csv' : 'csv');
          a.click();
          URL.revokeObjectURL(a.href);
          showToast('Exported ' + allProjectsData.length + ' projects');
        }

        // Close export menu on outside click
        document.addEventListener('click', function () {
          var menu = document.getElementById('proj-export-menu');
          if (menu && !menu.classList.contains('hidden')) menu.classList.add('hidden');
        });

        // ── Helpers ──
        function esc(str) {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }

        function formatDate(dateStr) {
          try {
            const d = new Date(dateStr);
            return (
              d.toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
              ' ' +
              d.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })
            );
          } catch {
            return dateStr;
          }
        }

        // ── Auto-login from stored refresh token ──
        async function tryAutoLogin() {
          if (!refreshToken) return;
          const ok = await tryRefresh();
          if (!ok) {
            localStorage.removeItem('appfactory_refresh_token');
            refreshToken = null;
            return;
          }
          try {
            const payload = JSON.parse(atob(accessToken.split('.')[1]));
            currentUser = {
              id: payload.userId,
              name: payload.roles.join(', '),
              fullName: null,
              roles: payload.roles.map((r) => ({ name: r })),
            };
            const userRes = await apiFetch('/api/users/' + payload.userId);
            if (userRes.ok) {
              const u = await userRes.json();
              currentUser = {
                id: u.id,
                name: u.name,
                fullName: u.fullName,
                roles: u.roles || [],
              };
            }
            enterApp();
          } catch {
            doLogout();
          }
        }

        // ── Init ──
        tryAutoLogin();
      })();
    </script>
  </body>
</html>
